(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","d3","threejs","dat.gui","JSRoot3DPainter","JSRootGeoBase"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");if(!b.nodejs&&(typeof window!="undefined")){require("./dat.gui.min.js")}a(b,require("./d3.min.js"),require("./three.min.js"),require("./JSRoot3DPainter.js"),require("./JSRootGeoBase.js"))}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof d3=="undefined"){throw new Error("d3 is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}if(typeof dat=="undefined"){throw new Error("dat.gui is not defined","JSRootGeoPainter.js")}a(JSROOT,d3,THREE)}}}(function(a,d,e){a.sources.push("geom");if(typeof define==="function"&&define.amd){a.loadScript("$$$style/JSRootGeoPainter.css")}if(typeof a.GEO!=="object"){console.error("JSROOT.GEO namespace is not defined")}function b(f,g,h){this.bright=h;if((f!==undefined)&&(typeof f.append=="function")){this.element=f.append("div").attr("class","jsroot");this.addButtons(g)}}b.prototype.addButtons=function(g){var f=this;this.buttonsNames=[];g.forEach(function(h){var i=f.element.append("div").attr("class","toolbar-group");h.forEach(function(k){var j=k.name;if(!j){throw new Error("must provide button 'name' in button config")}if(f.buttonsNames.indexOf(j)!==-1){throw new Error("button name '"+j+"' is taken")}f.buttonsNames.push(j);f.createButton(i,k)})})};b.prototype.createButton=function(h,f){var i=f.title;if(i===undefined){i=f.name}if(typeof f.click!=="function"){throw new Error("must provide button 'click' function in button config")}var g=h.append("a").attr("class",this.bright?"toolbar-btn-bright":"toolbar-btn").attr("rel","tooltip").attr("data-title",i).on("click",f.click);this.createIcon(g,f.icon||a.ToolbarIcons.question)};b.prototype.changeBrightness=function(f){this.bright=f;if(!this.element){return}this.element.selectAll(f?".toolbar-btn":".toolbar-btn-bright").attr("class",!f?"toolbar-btn":"toolbar-btn-bright")};b.prototype.createIcon=function(i,g){var h=g.size||512,l=g.scale||1,f=i.append("svg:svg").attr("height","1em").attr("width","1em").attr("viewBox",[0,0,h,h].join(" "));if("recs" in g){var k={};for(var m=0;m<g.recs.length;++m){a.extend(k,g.recs[m]);f.append("rect").attr("x",k.x).attr("y",k.y).attr("width",k.w).attr("height",k.h).attr("fill",k.f)}}else{var j=f.append("svg:path").attr("d",g.path);if(l!==1){j.attr("transform","scale("+l+" "+l+")")}}};b.prototype.removeAllButtons=function(){this.element.remove()};function c(f){if(f&&(f._typename==="TGeoManager")){this.geo_manager=f;f=f.fMasterVolume}if(f&&(f._typename.indexOf("TGeoVolume")===0)){f={_typename:"TGeoNode",fVolume:f,fName:f.fName,$geoh:f.$geoh,_proxy:true}}a.TObjectPainter.call(this,f);this.no_default_title=true;this.mode3d=true;this.Cleanup(true)}c.prototype=Object.create(a.TObjectPainter.prototype);c.prototype.CreateToolbar=function(g){if(this._toolbar||this._usesvg){return}var f=this;var h=[{name:"toImage",title:"Save as PNG",icon:a.ToolbarIcons.camera,click:function(){f.Render3D(0);var k=f._renderer.domElement.toDataURL("image/png");k.replace("image/png","image/octet-stream");var j=document.createElement("a");if(typeof j.download==="string"){document.body.appendChild(j);j.download="geometry.png";j.href=k;j.click();document.body.removeChild(j)}}}];h.push({name:"control",title:"Toggle control UI",icon:a.ToolbarIcons.rect,click:function(){f.showControlOptions("toggle")}});h.push({name:"enlarge",title:"Enlarge geometry drawing",icon:a.ToolbarIcons.circle,click:function(){f.ToggleEnlarge()}});if(a.gStyle.ContextMenu){h.push({name:"menu",title:"Show context menu",icon:a.ToolbarIcons.question,click:function(){d.event.preventDefault();d.event.stopPropagation();var j=d.event;if(!a.Painter.closeMenu()){a.Painter.createMenu(f,function(k){k.painter.FillContextMenu(k);k.show(j)})}}})}var i=new e.Color(this.options.background);this._toolbar=new b(this.select_main(),[h],(i.r+i.g+i.b)<1)};c.prototype.GetGeometry=function(){return this.GetObject()};c.prototype.ModifyVisisbility=function(g,f){if(a.GEO.NodeKind(this.GetGeometry())!==0){return}if(g==""){return a.GEO.SetBit(this.GetGeometry().fVolume,a.GEO.BITS.kVisThis,(f==="+"))}var i,h=false;if(g.indexOf("*")<0){i=new RegExp("^"+g+"$");h=true}else{i=new RegExp("^"+g.split("*").join(".*")+"$");h=false}this.FindNodeWithVolume(i,function(j){a.GEO.InvisibleAll.call(j.node.fVolume,(f!=="+"));return h?j:null})};c.prototype.decodeOptions=function(h){var r={_grid:false,_bound:false,_debug:false,_full:false,_axis:false,_axis_center:false,_count:false,wireframe:false,scale:new e.Vector3(1,1,1),zoom:1,more:1,maxlimit:100000,maxnodeslimit:3000,use_worker:false,update_browser:true,show_controls:false,highlight:false,select_in_view:false,project:"",is_main:false,tracks:false,clipx:false,clipy:false,clipz:false,ssao:false,script_name:"",transparency:0,autoRotate:false,background:"#FFFFFF",depthMethod:"box"};var o=a.GetUrlOption("_grid");if(o!==null&&o=="true"){r._grid=true}var o=a.GetUrlOption("_debug");if(o!==null&&o=="true"){r._debug=true;r._grid=true}if(o!==null&&o=="bound"){r._debug=true;r._grid=true;r._bound=true}if(o!==null&&o=="full"){r._debug=true;r._grid=true;r._full=true;r._bound=true}var l=h.indexOf("macro:");if(l>=0){var m=h.indexOf(";",l+6);if(m<0){m=h.length}r.script_name=h.substr(l+6,m-l-6);h=h.substr(0,l)+h.substr(m+1);console.log("script",r.script_name,"rest",h)}while(true){var i=h.indexOf("+"),n=h.indexOf("-");if((i<0)&&(n<0)){break}var t=i,k="+";if((t<0)||((n>=0)&&(n<i))){t=n;k="-"}var s=t+1,q=new RegExp("[,; .]");while((s<h.length)&&!q.test(h[s])&&(h[s]!="+")&&(h[s]!="-")){s++}var f=h.substring(t+1,s);h=h.substr(0,t)+h.substr(s);this.ModifyVisisbility(f,k)}var p=new a.DrawOptions(h);if(p.check("MAIN")){r.is_main=true}if(p.check("TRACKS")){r.tracks=true}if(p.check("DEPTHRAY")||p.check("DRAY")){r.depthMethod="ray"}if(p.check("DEPTHBOX")||p.check("DBOX")){r.depthMethod="box"}if(p.check("DEPTHPNT")||p.check("DPNT")){r.depthMethod="pnt"}if(p.check("DEPTHSIZE")||p.check("DSIZE")){r.depthMethod="size"}if(p.check("DEPTHDFLT")||p.check("DDFLT")){r.depthMethod="dflt"}if(p.check("ZOOM",true)){r.zoom=p.partAsInt(0,100)/100}if(p.check("BLACK")){r.background="#000000"}if(p.check("BKGR_",true)){var g=null;if(p.partAsInt(1)>0){g=a.Painter.root_colors[p.partAsInt()]}else{for(var j=0;j<8;++j){if(a.Painter.root_colors[j].toUpperCase()===p.part){g=a.Painter.root_colors[j]}}}if(g){r.background="#"+new e.Color(g).getHexString()}}if(p.check("MORE3")){r.more=3}if(p.check("MORE")){r.more=2}if(p.check("ALL")){r.more=100}if(p.check("CONTROLS")||p.check("CTRL")){r.show_controls=true}if(p.check("CLIPXYZ")){r.clipx=r.clipy=r.clipz=true}if(p.check("CLIPX")){r.clipx=true}if(p.check("CLIPY")){r.clipy=true}if(p.check("CLIPZ")){r.clipz=true}if(p.check("CLIP")){r.clipx=r.clipy=r.clipz=true}if(p.check("PROJX",true)){r.project="x";if(p.partAsInt(1)>0){r.projectPos=p.partAsInt()}}if(p.check("PROJY",true)){r.project="y";if(p.partAsInt(1)>0){r.projectPos=p.partAsInt()}}if(p.check("PROJZ",true)){r.project="z";if(p.partAsInt(1)>0){r.projectPos=p.partAsInt()}}if(p.check("DFLT_COLORS")||p.check("DFLT")){this.SetRootDefaultColors()}if(p.check("SSAO")){r.ssao=true}if(p.check("NOWORKER")){r.use_worker=-1}if(p.check("WORKER")){r.use_worker=1}if(p.check("NOHIGHLIGHT")||p.check("NOHIGH")){r.highlight=0}if(p.check("HIGHLIGHT")){r.highlight=true}if(p.check("WIRE")){r.wireframe=true}if(p.check("ROTATE")){r.autoRotate=true}if(p.check("INVX")||p.check("INVERTX")){r.scale.x=-1}if(p.check("INVY")||p.check("INVERTY")){r.scale.y=-1}if(p.check("INVZ")||p.check("INVERTZ")){r.scale.z=-1}if(p.check("COUNT")){r._count=true}if(p.check("TRANSP",true)){r.transparency=p.partAsInt(0,100)/100}if(p.check("OPACITY",true)){r.transparency=1-p.partAsInt(0,100)/100}if(p.check("AXISCENTER")||p.check("AC")){r._axis=true;r._axis_center=true}if(p.check("AXIS")||p.check("A")){r._axis=true}if(p.check("D")){r._debug=true}if(p.check("G")){r._grid=true}if(p.check("B")){r._bound=true}if(p.check("W")){r.wireframe=true}if(p.check("F")){r._full=true}if(p.check("Y")){r._yup=true}if(p.check("Z")){r._yup=false}return r};c.prototype.ActiavteInBrowser=function(g,f){if(typeof g=="string"){g=[g]}if(this._hpainter){this._hpainter.actiavte(g,f);if(!this.options.update_browser){setTimeout(this._hpainter.activate.bind(this._hpainter,[]),2000)}}};c.prototype.TestMatrixes=function(){var h=this,j=0,g=0,k=0;var f={domatrix:true,func:function(m){var r=this.getmatrix();var q=this.CopyStack();var t=h._clones.CreateObject3D(q.stack,h._toplevel,"mesh");if(!t){return true}g++;var s=t.matrixWorld,o,l;if(s.equals(r)){return true}if((s.determinant()>0)&&(r.determinant()<-0.9)){o=e.Vector3(1,1,-1);l=r;r=r.clone().scale(o);if(s.equals(r)){return true}}var p=0;for(var n=0;n<16;++n){p=Math.max(p,Math.abs(s.elements[n]-r.elements[n]))}k=Math.max(p,k);if(p<0.0001){return true}console.log(h._clones.ResolveStack(q.stack).name,"maxdiff",p,"determ",s.determinant(),r.determinant());j++;return false}};tm1=new Date().getTime();var i=this._clones.ScanVisible(f);tm2=new Date().getTime();console.log("Compare matrixes total",g,"errors",j,"takes",tm2-tm1,"maxdiff",k)};c.prototype.FillContextMenu=function(f){f.add("header: Draw options");f.addchk(this.options.update_browser,"Browser update",function(){this.options.update_browser=!this.options.update_browser;if(!this.options.update_browser){this.ActiavteInBrowser([])}});f.addchk(this.options.show_controls,"Show Controls",function(){this.showControlOptions("toggle")});f.addchk(this.TestAxisVisibility,"Show axes",function(){this.toggleAxisDraw()});f.addchk(this.options.wireframe,"Wire frame",function(){this.options.wireframe=!this.options.wireframe;this.changeWireFrame(this._scene,this.options.wireframe)});f.addchk(this.options.highlight,"Highlight volumes",function(){this.options.highlight=!this.options.highlight});f.add("Reset camera position",function(){this.focusCamera();this.Render3D()});if(!this.options.project){f.addchk(this.options.autoRotate,"Autorotate",function(){this.options.autoRotate=!this.options.autoRotate;this.autorotate(2.5)})}f.addchk(this.options.select_in_view,"Select in view",function(){this.options.select_in_view=!this.options.select_in_view;if(this.options.select_in_view){this.startDrawGeometry()}})};c.prototype.changeGlobalTransparency=function(f,g){var h=1-f;this._toplevel.traverse(function(i){if(i instanceof e.Mesh){if(i.material.alwaysTransparent!==undefined){if(!i.material.alwaysTransparent){i.material.transparent=h!==1}i.material.opacity=Math.min(h,i.material.inherentOpacity)}}});if(!g){this.Render3D(0)}};c.prototype.showControlOptions=function(m){if(m==="toggle"){m=!this._datgui}this.options.show_controls=m;if(this._datgui){if(m){return}d.select(this._datgui.domElement).remove();this._datgui.destroy();delete this._datgui;return}if(!m){return}var o=this;this._datgui=new dat.GUI({autoPlace:false,width:Math.min(650,o._renderer.domElement.width/2)});var j=this.select_main();if(j.style("position")=="static"){j.style("position","relative")}d.select(this._datgui.domElement).style("position","absolute").style("top",0).style("right",0);j.node().appendChild(this._datgui.domElement);if(this.options.project){var i=this.getGeomBoundingBox(this.getProjectionSource(),0.01);var h=this.options.project;if(this.options.projectPos===undefined){this.options.projectPos=(i.min[h]+i.max[h])/2}this._datgui.add(this.options,"projectPos",i.min[h],i.max[h]).name(h.toUpperCase()+" projection").onChange(function(r){o.startDrawGeometry()})}else{var i=this.getGeomBoundingBox(this._toplevel,0.01);var l=this._datgui.addFolder("Clipping");for(var n=0;n<3;++n){var h=!n?"x":((n===1)?"y":"z"),f=h.toUpperCase();l.add(this,"enable"+f).name("Enable "+f).listen().onChange(function(r){o._enableSSAO=r?false:o._enableSSAO;o.updateClipping()});var g="clip"+f;if(this[g]===0){this[g]=(i.min[h]+i.max[h])/2}var q=l.add(this,g,i.min[h],i.max[h]).name(f+" Position").onChange(function(r){if(o[this.enbale_flag]){o.updateClipping()}});q.enbale_flag="enable"+f}}var k=this._datgui.addFolder("Appearance");if(this._webgl){k.add(this,"_enableSSAO").name("Smooth Lighting (SSAO)").onChange(function(r){o._renderer.antialias=!o._renderer.antialias;o.enableX=r?false:o.enableX;o.enableY=r?false:o.enableY;o.enableZ=r?false:o.enableZ;o.updateClipping()}).listen()}k.add(this.options,"highlight").name("Highlight Selection").listen().onChange(function(r){if(!r){o.HighlightMesh(null)}});k.add(this.options,"transparency",0,1).listen().onChange(this.changeGlobalTransparency.bind(this));k.add(this.options,"wireframe").name("Wireframe").listen().onChange(function(r){o.changeWireFrame(o._scene,o.options.wireframe)});k.addColor(this.options,"background").name("Background").onChange(function(){o._renderer.setClearColor(o.options.background,1);o.Render3D(0);var r=new e.Color(o.options.background);o._toolbar.changeBrightness((r.r+r.g+r.b)<1)});k.add(this,"focusCamera").name("Reset camera position");if(this._webgl){var p=this._datgui.addFolder("Advanced");p.add(this._advceOptions,"aoClamp",0,1).listen().onChange(function(r){o._ssaoPass.uniforms.aoClamp.value=r;o._enableSSAO=true;o.Render3D(0)});p.add(this._advceOptions,"lumInfluence",0,1).listen().onChange(function(r){o._ssaoPass.uniforms.lumInfluence.value=r;o._enableSSAO=true;o.Render3D(0)});p.add(this._advceOptions,"clipIntersection").listen().onChange(function(r){o.clipIntersection=r;o.updateClipping()});p.add(this._advceOptions,"depthTest").onChange(function(r){o._toplevel.traverse(function(s){if(s instanceof e.Mesh){s.material.depthTest=r}});o.Render3D(0)}).listen();p.add(this,"resetAdvanced").name("Reset")}};c.prototype.OrbitContext=function(g,f){a.Painter.createMenu(this,function(j){var s=0,m=0,l=0;if(f){for(var k=0;k<f.length;++k){if(f[k].object.stack){m++}if(f[k].object.geo_name){s++}}}if(m+s===0){j.painter.FillContextMenu(j)}else{var i=(m+s)>1;if(i){j.add("header:"+((s>0)?"Items":"Nodes"))}for(var k=0;k<f.length;++k){var o=f[k].object,h,q,r;if(o.geo_name){q=o.geo_name;h=q.substr(q.lastIndexOf("/")+1);if(!h){h=q}r=h}else{if(o.stack){h=j.painter._clones.ResolveStack(o.stack).name;q=j.painter.GetStackFullName(o.stack);r=j.painter.GetItemName();if(h.indexOf("Nodes/")===0){r=h.substr(6)}else{if(h.length>0){r=h}else{if(!r){r="header"}}}}else{continue}}j.add((i?"sub:":"header:")+r,q,function(n){this.ActiavteInBrowser([n],true)});j.add("Browse",q,function(n){this.ActiavteInBrowser([n],true)});if(j.painter._hpainter){j.add("Inspect",q,function(n){this._hpainter.display(q,"inspect")})}if(o.geo_name){j.add("Hide",k,function(n){var t=f[n].object;t.visible=false;if(t.geo_object){t.geo_object.$hidden_via_menu=true}j.painter.Render3D()});if(i){j.add("endsub:")}continue}var p=j.painter.accessObjectWireFrame(o);if(p!==undefined){j.addchk(p,"Wireframe",k,function(t){var n=f[t].object.material;n.wireframe=!n.wireframe;this.Render3D()})}if(++l>1){j.add("Manifest",k,function(t){if(this._last_manifest){this._last_manifest.wireframe=!this._last_manifest.wireframe}if(this._last_hidden){this._last_hidden.forEach(function(u){u.visible=true})}this._last_hidden=[];for(var n=0;n<t;++n){this._last_hidden.push(f[n].object)}this._last_hidden.forEach(function(u){u.visible=false});this._last_manifest=f[t].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()})}j.add("Focus",k,function(n){this.focusCamera(f[n].object)});j.add("Hide",k,function(n){var t=j.painter._clones.ResolveStack(f[n].object.stack);if(t.obj&&(t.node.kind===0)&&t.obj.fVolume){a.GEO.SetBit(t.obj.fVolume,a.GEO.BITS.kVisThis,false);a.GEO.updateBrowserIcons(t.obj.fVolume,this._hpainter)}else{if(t.obj&&(t.node.kind===1)){t.obj.fRnrSelf=false;a.GEO.updateBrowserIcons(t.obj,this._hpainter)}}this.testGeomChanges()});if(i){j.add("endsub:")}}}j.show(g)})};c.prototype.FilterIntersects=function(o){for(var f=o.length-1;f>=0;--f){var l=o[f].object;var h=(l.stack!==undefined)||(l.geo_name!==undefined);for(var g=0;(g<f)&&h;++g){if(o[g].object===l){h=false}}if(!h){o.splice(f,1)}}if(this.enableX||this.enableY||this.enableZ){var q=[];for(var m=0;m<o.length;++m){var j=false;var p=o[m].point;if(this.enableX&&this._clipPlanes[0].normal.dot(p)>this._clipPlanes[0].constant){j=true}if(this.enableY&&this._clipPlanes[1].normal.dot(p)>this._clipPlanes[1].constant){j=true}if(this.enableZ&&this._clipPlanes[2].normal.dot(p)>this._clipPlanes[2].constant){j=true}if(j){q.push(o[m])}}o=q}return o};c.prototype.testCameraPositionChange=function(){if(!this.options.select_in_view||this._draw_all_nodes){return}var f=a.GEO.CreateProjectionMatrix(this._camera);var g=a.GEO.CreateFrustum(f);if(!g.CheckBox(this.getGeomBoundingBox(this._toplevel))){this.startDrawGeometry()}};c.prototype.ResolveStack=function(f){return this._clones&&f?this._clones.ResolveStack(f):null};c.prototype.GetStackFullName=function(g){var f=this.GetItemName(),h=this.ResolveStack(g);if(!h||!h.name){return f}return f?(f+"/"+h.name):h.name};c.prototype.HighlightMesh=function(f,h,o,m,n){if(!this.options.highlight){f=null}else{if(o){var g=this.getExtrasContainer();if(g&&g.children){for(var i=0;i<g.children.length;++i){if(g.children[i].geo_object===o){f=g.children[i];break}}}}else{if(m&&this._toplevel){this._toplevel.traverse(function(k){if((k instanceof e.Mesh)&&(k.stack===m)){f=k}})}}}if(!n){if(f){if(!o){o=f.geo_object}if(!m){m=f.stack}}var l=!this._main_painter?this._slave_painters:this._main_painter._slave_painters.concat([this._main_painter]);for(var i=0;i<l.length;++i){if(l[i]!==this){l[i].HighlightMesh(null,h,o,m,true)}}}var j=this._selected_mesh;if(j===f){return}if(j!==null){j.material.color=j.originalColor;delete j.originalColor;if(j.normalLineWidth){j.material.linewidth=j.normalLineWidth}if(j.normalMarkerSize){j.material.size=j.normalMarkerSize}}this._selected_mesh=f;if(f!==null){f.originalColor=f.material.color;f.material.color=new e.Color(h||16755251);if(f.hightlightLineWidth){f.material.linewidth=f.hightlightLineWidth}if(f.highlightMarkerSize){f.material.size=f.highlightMarkerSize}}this.Render3D(0)};c.prototype.addOrbitControls=function(){if(this._controls||this._usesvg){return}var f=this;this.tooltip_allowed=(a.gStyle.Tooltip>0);this._controls=a.Painter.CreateOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);if(this.options.project){this._controls.enableRotate=false}this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=function(l){var h=null,p=null,n=null,m=[];for(var i=0;i<l.length;++i){var j=l[i].object,g=null;if(!j){continue}if(j.geo_object){g=j.geo_name}else{if(j.stack){g=f.GetStackFullName(j.stack)}}if(g===null){continue}if(g.indexOf("<prnt>")==0){g=f.GetItemName()+g.substr(6)}m.push(g);if(!h){h=j;p=g;if(h.stack){n=f.ResolveStack(h.stack)}}}f.HighlightMesh(h);if(f.options.update_browser){if(f.options.highlight&&p){m=[p]}f.ActiavteInBrowser(m)}if(!n||!n.obj){return p}var o=a.GEO.provideInfo(n.obj);o.unshift(p);return{name:n.obj.fName,title:n.obj.fTitle||n.obj._typename,lines:o}};this._controls.ProcessMouseLeave=function(){if(f.options.update_browser){f.ActiavteInBrowser([])}};this._controls.ProcessDblClick=function(){if(f._last_manifest){f._last_manifest.wireframe=!f._last_manifest.wireframe;if(f._last_hidden){f._last_hidden.forEach(function(g){g.visible=true})}delete f._last_hidden;delete f._last_manifest;f.Render3D()}else{f.adjustCameraPosition()}}};c.prototype.addTransformControl=function(){if(this._tcontrols){return}if(!this.options._debug&&!this.options._grid){return}this._tcontrols=new e.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);var f=this;window.addEventListener("keydown",function(g){switch(g.keyCode){case 81:f._tcontrols.setSpace(f._tcontrols.space==="local"?"world":"local");break;case 17:f._tcontrols.setTranslationSnap(Math.ceil(f._overall_size)/50);f._tcontrols.setRotationSnap(e.Math.degToRad(15));break;case 84:f._tcontrols.setMode("translate");break;case 82:f._tcontrols.setMode("rotate");break;case 83:f._tcontrols.setMode("scale");break;case 187:case 107:f._tcontrols.setSize(f._tcontrols.size+0.1);break;case 189:case 109:f._tcontrols.setSize(Math.max(f._tcontrols.size-0.1,0.1));break}});window.addEventListener("keyup",function(g){switch(g.keyCode){case 17:f._tcontrols.setTranslationSnap(null);f._tcontrols.setRotationSnap(null);break}});this._tcontrols.addEventListener("change",function(){f.Render3D(0)})};c.prototype.nextDrawAction=function(){if(!this._clones||(this.drawing_stage==0)){return false}if(this.drawing_stage==1){if(this.options.use_worker>0){if(!this._worker){this.startWorker();return 1}if(!this._worker_ready){return 1}}var t=this._clones.MarkVisisble(),z=null,s=null;if(this.options.select_in_view&&!this._first_drawing){z=a.GEO.CreateProjectionMatrix(this._camera);s=a.GEO.CreateFrustum(z);if(s.CheckBox(this.getGeomBoundingBox(this._toplevel))){z=null;s=null}}this._current_face_limit=this.options.maxlimit;this._current_nodes_limit=this.options.maxnodeslimit;if(z){this._current_face_limit*=1.25;this._current_nodes_limit*=1.25}var w=!a.BatchMode&&((t>10000)||(z&&(this._clones.ScanVisible()>100000)));if(w&&a.source_dir.indexOf("file://")==0){console.log("disable worker for jsroot from file system");w=false}if(w&&!this._worker&&(this.options.use_worker>=0)){this.startWorker()}if(!w||!this._worker_ready){var F=this._clones.CollectVisibles(this._current_face_limit,s,this._current_nodes_limit);this._new_draw_nodes=F.lst;this._draw_all_nodes=F.complete;this.drawing_stage=3;return true}var p={collect:this._current_face_limit,collect_nodes:this._current_nodes_limit,visible:this._clones.GetVisibleFlags(),matrix:z?z.elements:null};this.submitToWorker(p);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==2){this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==3){this.drawing_log="Analyse visibles";if(this._draw_nodes){var r=this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(var y=0;y<r.length;++y){this._clones.CreateObject3D(r[y].stack,this._toplevel,"delete_mesh")}if(r.length>0){this.drawing_log="Delete "+r.length+" nodes"}}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return true}if(this.drawing_stage===4){this.drawing_log="Collect shapes";var x=this._clones.CollectShapes(this._draw_nodes);this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,x);this.drawing_stage=5;return true}if(this.drawing_stage===5){if(this.canSubmitToWorker()){var p={limit:this._current_face_limit,shapes:[]},A=0;for(var y=0;y<this._build_shapes.length;++y){var D=null,C=this._build_shapes[y];if(C.ready||C.geom){D={id:C.id,ready:true,nfaces:a.GEO.numGeometryFaces(C.geom),refcnt:C.refcnt}}else{D=a.clone(C,null,true);A++}p.shapes.push(D)}if(A>0){this.submitToWorker(p);this.drawing_log="Worker build shapes";this.drawing_stage=6;return 2}}this.drawing_stage=7}if(this.drawing_stage===6){return 2}if((this.drawing_stage===7)||(this.drawing_stage===8)){if(this.drawing_stage===7){var F=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500);if(F.done){this.drawing_stage=8}else{this.drawing_log="Creating: "+F.shapes+" / "+this._build_shapes.length+" shapes,  "+F.faces+" faces";if(F.notusedshapes<30){return true}}}var m=new Date().getTime(),u=true,v=this.options.project?this._full_geom:this._toplevel;for(var y=0;y<this._draw_nodes.length;++y){var i=this._draw_nodes[y];if(i.done){continue}var h=this._build_shapes[i.shapeid];if(!h.ready){if(this.drawing_stage===8){console.warn("shape marked as not ready when should")}u=false;continue}i.done=true;h.used=true;if(!h.geom||(h.nfaces===0)){this._clones.CreateObject3D(i.stack,v,"delete_mesh");continue}var o=this._clones.origin[i.nodeid];var D=this._clones.nodes[i.nodeid];var j=a.GEO.getNodeProperties(D.kind,o,true);this._num_meshes++;this._num_faces+=h.nfaces;var E=this._clones.CreateObject3D(i.stack,v,this.options);j.material.wireframe=this.options.wireframe;j.material.side=this.bothSides?e.DoubleSide:e.FrontSide;var g;if(E.matrixWorld.determinant()>-0.9){g=new e.Mesh(h.geom,j.material)}else{g=a.GEO.createFlippedMesh(E,h,j.material)}E.add(g);g.stack=i.stack;g.renderOrder=this._clones.maxdepth-i.stack.length;g.$jsroot_order=E.$jsroot_depth;if(this.options._debug||this.options._full){var q=new e.WireframeGeometry(g.geometry),l=new e.LineBasicMaterial({color:j.fillcolor,linewidth:(o&&o.fVolume)?o.fVolume.fLineWidth:1}),f=new e.LineSegments(q,l);E.add(f)}if(this.options._bound||this.options._full){var B=new e.BoxHelper(g);E.add(B)}var k=new Date().getTime();if(k-m>500){u=false;break}}if(u){if(this.options.project){this.drawing_log="Build projection";this.drawing_stage=10;return true}this.drawing_log="Building done";this.drawing_stage=0;return false}if(this.drawing_stage>7){this.drawing_log="Building meshes "+this._num_meshes+" / "+this._num_faces}return true}if(this.drawing_stage===9){if(!this._main_painter){console.warn("MAIN PAINTER DISAPPER");this.drawing_stage=0;return false}if(!this._main_painter._drawing_ready){return 1}this.drawing_stage=10}if(this.drawing_stage===10){this.doProjection();this.drawing_log="Building done";this.drawing_stage=0;return false}console.error("never come here stage = "+this.drawing_stage);return false};c.prototype.getProjectionSource=function(){if(this._clones_owner){return this._full_geom}if(!this._main_painter){console.warn("MAIN PAINTER DISAPPER");return null}if(!this._main_painter._drawing_ready){console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION");return null}return this._main_painter._toplevel};c.prototype.getGeomBoundingBox=function(h,g){var f=new e.Box3();if(!h){f.min.x=f.min.y=f.min.z=-1;f.max.x=f.max.y=f.max.z=1;return f}f.makeEmpty();h.traverse(function(i){if((i instanceof e.Mesh)&&i.stack){a.GEO.getBoundingBox(i,f)}});if(g!==undefined){f.expandByVector(f.getSize().multiplyScalar(g))}return f};c.prototype.doProjection=function(){var l=this.getProjectionSource(),h=this;if(!l){return false}a.Painter.DisposeThreejsObject(this._toplevel,true);var k=this.options.project;if(this.options.projectPos===undefined){var j=this.getGeomBoundingBox(l),i=j.min[this.options.project],f=j.max[this.options.project],g=(i+f)/2;if((i<0)&&(f>0)&&(Math.abs(g)<0.2*Math.max(-i,f))){g=0}this.options.projectPos=g}l.traverse(function(o){if(!(o instanceof e.Mesh)||!o.stack){return}var n=a.GEO.projectGeometry(o.geometry,o.parent.matrixWorld,h.options.project,h.options.projectPos,o._flippedMesh);if(!n){return}var m=new e.Mesh(n,o.material.clone());h._toplevel.add(m);m.stack=o.stack});return true};c.prototype.SameMaterial=function(h,f){if((h===null)||(f===null)){return h===f}if(h.fVolume.fLineColor>=0){return(h.fVolume.fLineColor===f.fVolume.fLineColor)}var i=(h.fVolume.fMedium!==null)?h.fVolume.fMedium.fMaterial:null;var g=(f.fVolume.fMedium!==null)?f.fVolume.fMedium.fMaterial:null;if(i===g){return true}if((i===null)||(g===null)){return false}return(i.fFillStyle===g.fFillStyle)&&(i.fFillColor===g.fFillColor)};c.prototype.createScene=function(n,l,g,j){this._scene=new e.Scene();this._scene.fog=new e.Fog(16777215,1,10000);this._scene.overrideMaterial=new e.MeshLambertMaterial({color:7340287,transparent:true,opacity:0.2,depthTest:false});this._scene_width=g;this._scene_height=j;this._camera=new e.PerspectiveCamera(25,g/j,1,10000);this._camera.up=this.options._yup?new e.Vector3(0,1,0):new e.Vector3(0,0,1);this._scene.add(this._camera);this._selected_mesh=null;this._overall_size=10;this._toplevel=new e.Object3D();this._scene.add(this._toplevel);if(n){this._renderer=new e.SVGRenderer({precision:0,astext:true});if(this._renderer.outerHTML!==undefined){if(!a.svg_workaround){a.svg_workaround=[]}var m=(typeof document==="undefined")?a.nodejs_document:document;this._renderer.domElement=m.createElementNS("http://www.w3.org/2000/svg","path");this._renderer.workaround_id=a.svg_workaround.length;this._renderer.domElement.setAttribute("jsroot_svg_workaround",this._renderer.workaround_id);a.svg_workaround[this._renderer.workaround_id]="<svg></svg>"}}else{this._renderer=l?new e.WebGLRenderer({antialias:true,logarithmicDepthBuffer:false,preserveDrawingBuffer:true}):new e.CanvasRenderer({antialias:true});this._renderer.setPixelRatio(window.devicePixelRatio)}this._renderer.setClearColor(this.options.background,1);this._renderer.setSize(g,j,!this._fit_main_area);this._renderer.localClippingEnabled=true;if(this._fit_main_area&&!n){this._renderer.domElement.style.width="100%";this._renderer.domElement.style.height="100%";var f=this.select_main();if(f.style("position")=="static"){f.style("position","relative")}}this._animating=false;this.clipIntersection=true;this.bothSides=false;this.enableX=this.enableY=this.enableZ=false;this.clipX=this.clipY=this.clipZ=0;this._clipPlanes=[new e.Plane(new e.Vector3(1,0,0),this.clipX),new e.Plane(new e.Vector3(0,this.options._yup?-1:1,0),this.clipY),new e.Plane(new e.Vector3(0,0,this.options._yup?1:-1),this.clipZ)];this._pointLight=new e.PointLight(15724527,1);this._camera.add(this._pointLight);this._pointLight.position.set(10,10,10);this._defaultAdvanced={aoClamp:0.7,lumInfluence:0.4,clipIntersection:true,depthTest:true};this._enableSSAO=this.options.ssao;if(l){var k=new e.RenderPass(this._scene,this._camera);this._depthMaterial=new e.MeshDepthMaterial({side:e.DoubleSide});this._depthMaterial.depthPacking=e.RGBADepthPacking;this._depthMaterial.blending=e.NoBlending;var i={minFilter:e.LinearFilter,magFilter:e.LinearFilter};this._depthRenderTarget=new e.WebGLRenderTarget(g,j,i);this._ssaoPass=new e.ShaderPass(e.SSAOShader);this._ssaoPass.renderToScreen=true;this._ssaoPass.uniforms.tDepth.value=this._depthRenderTarget.texture;this._ssaoPass.uniforms.size.value.set(g,j);this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far;this._ssaoPass.uniforms.onlyAO.value=false;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence;this._effectComposer=new e.EffectComposer(this._renderer);this._effectComposer.addPass(k);this._effectComposer.addPass(this._ssaoPass)}this._advceOptions={};this.resetAdvanced()};c.prototype.startDrawGeometry=function(f){if(!f&&(this.drawing_stage!==0)){this._draw_nodes_again=true;return}this._startm=new Date().getTime();this._last_render_tm=this._startm;this._last_render_meshes=0;this.drawing_stage=1;this._drawing_ready=false;this.drawing_log="collect visible";this._num_meshes=0;this._num_faces=0;this._selected_mesh=null;if(this.options.project){if(this._clones_owner){if(this._full_geom){this.drawing_stage=10;this.drawing_log="build projection"}else{this._full_geom=new e.Object3D()}}else{this.drawing_stage=9;this.drawing_log="wait for main painter"}}delete this._last_manifest;delete this._last_hidden;delete this._draw_nodes_again;this.continueDraw()};c.prototype.resetAdvanced=function(){if(this._webgl){this._advceOptions.aoClamp=this._defaultAdvanced.aoClamp;this._advceOptions.lumInfluence=this._defaultAdvanced.lumInfluence;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence}this._advceOptions.depthTest=this._defaultAdvanced.depthTest;this._advceOptions.clipIntersection=this._defaultAdvanced.clipIntersection;this.clipIntersection=this._defaultAdvanced.clipIntersection;var f=this;this._toplevel.traverse(function(g){if(g instanceof e.Mesh){g.material.depthTest=f._defaultAdvanced.depthTest}});this.Render3D(0)};c.prototype.updateMaterialSide=function(f,g){if((this.bothSides===f)&&!g){return}this._scene.traverse(function(h){if(h.hasOwnProperty("material")&&("emissive" in h.material)){h.material.side=f?e.DoubleSide:e.FrontSide;h.material.needsUpdate=true}});this.bothSides=f};c.prototype.updateClipping=function(g){this._clipPlanes[0].constant=this.clipX;this._clipPlanes[1].constant=-this.clipY;this._clipPlanes[2].constant=this.options._yup?-this.clipZ:this.clipZ;var f=this;this._scene.traverse(function(h){if(h instanceof e.Mesh){h.material.clipIntersection=f.clipIntersection;h.material.clippingPlanes=[];if(f.enableX){h.material.clippingPlanes.push(f._clipPlanes[0])}if(f.enableY){h.material.clippingPlanes.push(f._clipPlanes[1])}if(f.enableZ){h.material.clippingPlanes.push(f._clipPlanes[2])}}});this.updateMaterialSide(this.enableX||this.enableY||this.enableZ);if(!g){this.Render3D(0)}};c.prototype.getGeomBox=function(){var g=this.getExtrasContainer("collect");var h=this.getGeomBoundingBox(this._toplevel);if(g){for(var f=0;f<g.length;++f){this._toplevel.add(g[f])}}return h};c.prototype.adjustCameraPosition=function(m){if(!this._toplevel){return}var j=this.getGeomBoundingBox(this._toplevel);var o=j.max.x-j.min.x,n=j.max.y-j.min.y,l=j.max.z-j.min.z,i=(j.max.x+j.min.x)/2,h=(j.max.y+j.min.y)/2,f=(j.max.z+j.min.z)/2;this._overall_size=2*Math.max(o,n,l);this._scene.fog.near=this._overall_size*2;this._camera.near=this._overall_size/350;this._scene.fog.far=this._overall_size*12;this._camera.far=this._overall_size*12;if(this._webgl){this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far}if(m){this.clipX=i;this.clipY=h;this.clipZ=f}this._camera.updateProjectionMatrix();var g=2*this.options.zoom;if(this.options.project){switch(this.options.project){case"x":this._camera.position.set(g*1.5*Math.max(n,l),0,0);break;case"y":this._camera.position.set(0,g*1.5*Math.max(o,l),0);break;case"z":this._camera.position.set(0,0,g*1.5*Math.max(o,n));break}}else{if(this.options._yup){this._camera.position.set(i-g*Math.max(o,l),h+g*n,f-g*Math.max(o,l))}else{this._camera.position.set(i-g*Math.max(o,n),h-g*Math.max(o,n),f+g*l)}}this._lookat=new e.Vector3(i,h,f);this._camera.lookAt(this._lookat);this._pointLight.position.set(o/5,n/5,l/5);if(this._controls){this._controls.target.copy(this._lookat);this._controls.update()}if(this.options.select_in_view){this.startDrawGeometry()}};c.prototype.focusOnItem=function(h){if(!h||!this._clones){return}var f=this._clones.FindStackByName(h);if(!f){return}var g=this._clones.ResolveStack(f,true);this.focusCamera(g,false)};c.prototype.focusCamera=function(p,y){if(this.options.project){return this.adjustCameraPosition()}var t=y===undefined?false:y;var n=new e.Box3();if(p===undefined){n=this.getGeomBoundingBox(this._toplevel)}else{if(p instanceof e.Mesh){n.setFromObject(p)}else{var D=new e.Vector3().setFromMatrixPosition(p.matrix),s=p.node,q=new e.Vector3(s.fDX,s.fDY,s.fDZ).multiplyScalar(0.5);n.min=D.clone().sub(q);n.max=D.clone().add(q)}}var C=n.max.x-n.min.x,A=n.max.y-n.min.y,z=n.max.z-n.min.z,x=(n.max.x+n.min.x)/2,w=(n.max.y+n.min.y)/2,u=(n.max.z+n.min.z)/2;var F;if(this.options._yup){F=new e.Vector3(x-2*Math.max(C,z),w+2*A,u-2*Math.max(C,z))}else{F=new e.Vector3(x-2*Math.max(C,A),w-2*Math.max(C,A),u+2*z)}var E=new e.Vector3(x,w,u);var r=this._camera.position.distanceTo(E);var v=this._controls.target;var o=200;var l=0;var i=F.sub(this._camera.position).divideScalar(o);var m=E.sub(v).divideScalar(o);if(t){var j=this.getGeomBoundingBox(this._toplevel);this.clipX=this.enableX?this.clipX:j.min.x;this.clipY=this.enableY?this.clipY:j.min.y;this.clipZ=this.enableZ?this.clipZ:j.min.z;this.enableX=this.enableY=this.enableZ=true;var h=((n.max.x+n.min.x)/2-this.clipX)/o,g=((n.max.y+n.min.y)/2-this.clipY)/o,f=((n.max.z+n.min.z)/2-this.clipZ)/o;this.updateClipping()}var B=this;this._animating=true;function k(){if(B._animating===undefined){return}if(B._animating){requestAnimationFrame(k)}else{B.startDrawGeometry()}var G=-Math.cos((2*Math.PI*l)/o)+1;B._camera.position.add(i.clone().multiplyScalar(G));v.add(m.clone().multiplyScalar(G));B._lookat=v;B._camera.lookAt(B._lookat);B._camera.updateProjectionMatrix();if(t){B.clipX+=h*G;B.clipY+=g*G;B.clipZ+=f*G;B.updateClipping()}else{B.Render3D()}l++;B._animating=l<o}k()};c.prototype.autorotate=function(j){var h=(j===undefined)?2:j,f=this,i=new Date();function g(){if(!f._renderer||!f.options){return}var k=new Date();if(f.options.autoRotate){requestAnimationFrame(g)}if(f._controls){f._controls.autoRotate=f.options.autoRotate;f._controls.autoRotateSpeed=h*(k.getTime()-i.getTime())/16.6666;f._controls.update()}i=new Date();f.Render3D(0)}if(this._webgl){g()}};c.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var f=new e.BoxHelper(this._toplevel);this._scene.add(f)}this._scene.add(new e.AxisHelper(2*this._overall_size));this._scene.add(new e.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};c.prototype.drawCount=function(n,j){var k="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+n+"<br/>Time to clone: "+j+"ms <br/>";this._clones.ScanVisible();var m=this,o=0;var p={cnt:[],func:function(q){if(this.cnt[this.last]===undefined){this.cnt[this.last]=1}else{this.cnt[this.last]++}o+=a.GEO.CountNumShapes(m._clones.GetNodeShape(q.id));return true}};var g=new Date().getTime();var i=this._clones.ScanVisible(p);var f=new Date().getTime();k+="Total visible nodes: "+i+"<br/>";k+="Total shapes: "+o+"<br/>";for(var l=0;l<p.cnt.length;++l){if(p.cnt[l]!==undefined){k+=("  lvl"+l+": "+p.cnt[l]+"<br/>")}}k+="Time to scan: "+(f-g)+"ms <br/>";k+="<br/><br/>Check timing for matrix calculations ...<br/>";var h=this.select_main().style("overflow","auto").html(k);setTimeout(function(){p.domatrix=true;g=new Date().getTime();i=m._clones.ScanVisible(p);f=new Date().getTime();h.append("p").text("Time to scan with matrix: "+(f-g)+"ms");m.DrawingReady()},100);return this};c.prototype.PerformDrop=function(l,m,g,h,k){if(l&&(l.$kind==="TTree")){var f="extract_geo_tracks";if(h&&h.indexOf("$")>0){f=h.substr(0,h.indexOf("$"));h=h.substr(h.indexOf("$")+1)}var j=a.findFunction(f);if(!j){return a.CallBack(k)}var i=this;return j(l,h,function(n){if(n){i.drawExtras(n);i.Render3D(100)}a.CallBack(k)})}if(this.drawExtras(l,m,true)){if(g){g._painter=this}this.Render3D(100)}a.CallBack(k)};c.prototype.MouseOverHierarchy=function(f,i,g){if(!this.options){return}var h=g._obj;if(this.options._debug){console.log("Mouse over",f,i,(h?h._typename:"---"))}if(!h||(h._typename!=="TEveTrack"&&h._typename!=="TEvePointSet"&&h._typename!=="TPolyMarker3D")){return}this.HighlightMesh(null,65280,f?h:null)};c.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.Render3D()};c.prototype.addExtra=function(f,g){if(this._extraObjects===undefined){this._extraObjects=a.Create("TList")}if(this._extraObjects.arr.indexOf(f)>=0){return false}this._extraObjects.Add(f,g);delete f.$hidden_via_menu;return true};c.prototype.ExtraObjectVisible=function(j,g,f){if(!this._extraObjects){return}var m=j.itemFullName(g),i=this._extraObjects.opt.indexOf(m);if((i<0)&&g._obj){i=this._extraObjects.arr.indexOf(g._obj);if(i>=0){this._extraObjects.opt[i]=m}}if(i<0){return}var k=this._extraObjects.arr[i],h=k.$hidden_via_menu?false:true;if(f){k.$hidden_via_menu=h;h=!h;var l=null;this._toplevel.traverse(function(n){if(n.geo_object===k){l=n}});if(l){l.visible=h}else{if(h){this.drawExtras(k)}}if(l||h){this.Render3D()}}return h};c.prototype.drawExtras=function(i,l,j){if(!i||i._typename===undefined){return false}if(!j&&i.$hidden_via_menu){return false}var h=false;if((i._typename==="TList")||(i._typename==="TObjArray")){if(!i.arr){return false}for(var k=0;k<i.arr.length;++k){var g=i.arr[k];var f=(l===undefined)?i.opt[k]:(l+"/["+k+"]");if(this.drawExtras(g,f,j)){h=true}}}else{if(i._typename==="TGeoTrack"){if(j&&!this.addExtra(i,l)){return false}h=this.drawGeoTrack(i,l)}else{if(i._typename==="TEveTrack"){if(j&&!this.addExtra(i,l)){return false}h=this.drawEveTrack(i,l)}else{if((i._typename==="TEvePointSet")||(i._typename==="TPolyMarker3D")){if(j&&!this.addExtra(i,l)){return false}h=this.drawHit(i,l)}else{if(i._typename==="TEveGeoShapeExtract"){if(j&&!this.addExtra(i,l)){return false}h=this.drawExtraShape(i,l)}}}}}return h};c.prototype.getExtrasContainer=function(l,h){if(!this._toplevel){return null}if(!h){h="tracks"}var i=null,f=[];for(var m=0;m<this._toplevel.children.length;++m){var j=this._toplevel.children[m];if(!j._extras){continue}if(l==="collect"){f.push(j);continue}if(j._extras===h){i=j;break}}if(l==="collect"){for(var g=0;g<f.length;++g){this._toplevel.remove(f[g])}return f}if(l==="delete"){if(i){this._toplevel.remove(i)}a.Painter.DisposeThreejsObject(i);return null}if((l!=="get")&&!i){i=new e.Object3D();i._extras=h;this._toplevel.add(i)}return i};c.prototype.drawGeoTrack=function(h,o){if(!h||!h.fNpoints){return false}var s=h.fLineWidth||1,f=a.Painter.root_colors[h.fLineColor]||"rgb(255,0,255)";if(a.browser.isWin){s=1}var q=Math.round(h.fNpoints/4),g=new Float32Array((q-1)*6),r=0,p=this.options.projectPos,n=(this.options.project==="x"),m=(this.options.project==="y"),l=(this.options.project==="z");for(var j=0;j<q-1;++j){g[r]=n?p:h.fPoints[j*4];g[r+1]=m?p:h.fPoints[j*4+1];g[r+2]=l?p:h.fPoints[j*4+2];g[r+3]=n?p:h.fPoints[j*4+4];g[r+4]=m?p:h.fPoints[j*4+5];g[r+5]=l?p:h.fPoints[j*4+6];r+=6}var i=new e.LineBasicMaterial({color:f,linewidth:s}),t=a.Painter.createLineSegments(g,i);t.geo_name=o;t.geo_object=h;if(!a.browser.isWin){t.hightlightLineWidth=s*3;t.normalLineWidth=s}this.getExtrasContainer().add(t);return true};c.prototype.drawEveTrack=function(h,o){if(!h||(h.fN<=0)){return false}var r=h.fLineWidth||1,f=a.Painter.root_colors[h.fLineColor]||"rgb(255,0,255)";if(a.browser.isWin){r=1}var g=new Float32Array((h.fN-1)*6),q=0,p=this.options.projectPos,n=(this.options.project==="x"),m=(this.options.project==="y"),l=(this.options.project==="z");for(var j=0;j<h.fN-1;++j){g[q]=n?p:h.fP[j*3];g[q+1]=m?p:h.fP[j*3+1];g[q+2]=l?p:h.fP[j*3+2];g[q+3]=n?p:h.fP[j*3+3];g[q+4]=m?p:h.fP[j*3+4];g[q+5]=l?p:h.fP[j*3+5];q+=6}var i=new e.LineBasicMaterial({color:f,linewidth:r}),s=a.Painter.createLineSegments(g,i);s.geo_name=o;s.geo_object=h;if(!a.browser.isWin){s.hightlightLineWidth=r*3;s.normalLineWidth=r}this.getExtrasContainer().add(s);return true};c.prototype.drawHit=function(f,m){if(!f||!f.fN||(f.fN<0)){return false}var n=8*f.fMarkerSize,q=f.fN-1,o=this.options.projectPos,l=(this.options.project==="x"),k=(this.options.project==="y"),j=(this.options.project==="z"),g=new a.Painter.PointsCreator(q,this._webgl,n);for(var h=0;h<q;h++){g.AddPoint(l?o:f.fP[h*3],k?o:f.fP[h*3+1],j?o:f.fP[h*3+2])}var p=g.CreatePoints(a.Painter.root_colors[f.fMarkerColor]||"rgb(0,0,255)");p.highlightMarkerSize=n*3;p.normalMarkerSize=n;p.geo_name=m;p.geo_object=f;this.getExtrasContainer().add(p);return true};c.prototype.drawExtraShape=function(g,h){var f=a.GEO.build(g);if(!f){return false}f.geo_name=h;f.geo_object=g;this.getExtrasContainer().add(f);return true};c.prototype.FindNodeWithVolume=function(f,j,i,l,o){var h=false,m=null;if(!i){i=this.GetGeometry();if(!i&&(a.GEO.NodeKind(i)!==0)){return null}l=this.geo_manager?i.fName:"";h=true;o=[]}else{if(l.length>0){l+="/"}l+=i.fName}if(!i.fVolume||i.fVolume._searched){return null}if(f.test(i.fVolume.fName)){m=j({node:i,item:l});if(m){return m}}i.fVolume._searched=true;o.push(i.fVolume);if(i.fVolume.fNodes){for(var g=0;g<i.fVolume.fNodes.arr.length;++g){m=this.FindNodeWithVolume(f,j,i.fVolume.fNodes.arr[g],l,o);if(m){break}}}if(h){for(var g=0,k=o.length;g<k;++g){delete o[g]._searched}}return m};c.prototype.SetRootDefaultColors=function(){var k={kWhite:0,kBlack:1,kGray:920,kRed:632,kGreen:416,kBlue:600,kYellow:400,kMagenta:616,kCyan:432,kOrange:800,kSpring:820,kTeal:840,kAzure:860,kViolet:880,kPink:900};var f=110,h=[];for(var j=0;j<f;j++){h.push(k.kGray)}h[3]=k.kYellow-10;h[4]=h[5]=k.kGreen-10;h[6]=h[7]=k.kBlue-7;h[8]=h[9]=k.kMagenta-3;h[10]=h[11]=k.kRed-10;h[12]=k.kGray+1;h[13]=k.kBlue-10;h[14]=k.kOrange+7;h[16]=k.kYellow+1;h[20]=k.kYellow-10;h[24]=h[25]=h[26]=k.kBlue-8;h[29]=k.kOrange+9;h[79]=k.kOrange-2;var g={test:function(){return true}};this.FindNodeWithVolume(g,function(i){var m=i.node.fVolume;var n=m.fMedium;if(!n){return null}var l=n.fMaterial;var o=Math.round(l.fZ);m.fLineColor=h[o];if(l.fDensity<0.1){l.fFillStyle=3000+60}})};c.prototype.checkScript=function(k,i){var f=this,j=this.GetGeometry(),g="";if(this.geo_manager){g=j.fName}if(!k||(k.length<3)||(a.GEO.NodeKind(j)!==0)){return a.CallBack(i,j,g)}var h={GetVolume:function(m){var n=new RegExp("^"+m+"$");var l=f.FindNodeWithVolume(n,function(o){return o});if(!l){console.log("Did not found "+m+" volume")}return{found:l,fVolume:l?l.node.fVolume:null,InvisibleAll:function(o){a.GEO.InvisibleAll.call(this.fVolume,o)},Draw:function(){if(!this.found||!this.fVolume){return}j=this.found.node;g=this.found.item;console.log("Select volume for drawing",this.fVolume.fName,g)},SetTransparency:function(o){if(this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial){this.fVolume.fMedium.fMaterial.fFillStyle=3000+o}},SetLineColor:function(o){if(this.fVolume){this.fVolume.fLineColor=o}}}},DefaultColors:function(){f.SetRootDefaultColors()},SetMaxVisNodes:function(l){console.log("Automatic visible depth for "+l+" nodes");if(l>0){f.options.maxnodeslimit=l}}};a.progress("Loading macro "+k);a.NewHttpRequest(k,"text",function(m){if(!m||(m.length==0)){return a.CallBack(i,j,g)}var l=m.split("\n");n(0);function n(s){var t=new Date().getTime();while(s<l.length){var o=l[s++].trim();if(o.indexOf("//")==0){continue}if(o.indexOf("gGeoManager")<0){continue}o=o.replace("->GetVolume",".GetVolume");o=o.replace("->InvisibleAll",".InvisibleAll");o=o.replace("->SetMaxVisNodes",".SetMaxVisNodes");o=o.replace("->DefaultColors",".DefaultColors");o=o.replace("->Draw",".Draw");o=o.replace("->SetTransparency",".SetTransparency");o=o.replace("->SetLineColor",".SetLineColor");if(o.indexOf("->")>=0){continue}try{var r=new Function("gGeoManager",o);r(h)}catch(q){console.error("Problem by processing "+o)}var p=new Date().getTime();if(p-t>300){a.progress("exec "+o);return setTimeout(n.bind(this,s),1)}}a.CallBack(i,j,g)}}).send()};c.prototype.prepareObjectDraw=function(j,g){if(this._main_painter){this._clones_owner=false;this._clones=null;this._clones=this._main_painter._clones;console.log("Reuse clones",this._clones.nodes.length,"from main painter")}else{this._start_drawing_time=new Date().getTime();this._clones_owner=true;this._clones=new a.GEO.ClonedNodes(j);this._clones.name_prefix=g;var h=this._clones.MarkVisisble(true);if(h<=0){h=this._clones.MarkVisisble(false)}else{h=this._clones.MarkVisisble(true,true)}var i=new Date().getTime()-this._start_drawing_time;console.log("Creating clones",this._clones.nodes.length,"takes",i,"uniquevis",h);if(this.options._count){return this.drawCount(h,i)}}this.options.maxlimit=(this._webgl?200000:100000)*this.options.more;this._first_drawing=true;if(this.options.use_worker>0){this.startWorker()}var f=this.size_for_3d(this._usesvg?3:undefined);this._fit_main_area=(f.can3d===-1);this.createScene(this._usesvg,this._webgl,f.width,f.height);this.add_3d_canvas(f,this._renderer.domElement);this.AccessTopPainter(true);this.CreateToolbar();this.showDrawInfo("Drawing geometry");this.startDrawGeometry(true)};c.prototype.showDrawInfo=function(i){if(!this._first_drawing||!this._start_drawing_time){return}var f=this._renderer.domElement.parentNode,g=d.select(f).select(".geo_info");if(!i){g.remove()}else{var h=(new Date().getTime()-this._start_drawing_time)*0.001;if(g.empty()){g=d.select(f).append("p").attr("class","geo_info")}g.html(i+", "+h.toFixed(1)+"s")}};c.prototype.continueDraw=function(){if(this.drawing_stage===0){return}var g=new Date().getTime(),f=this._first_drawing?1000:200,h=g;while(true){var i=this.nextDrawAction();if(!i){break}h=new Date().getTime();if(h-this._startm>100000){this.drawing_stage=0;break}if((i===true)&&(h-g<f)){continue}if((h-g>f)||(i===1)||(i===2)){a.progress(this.drawing_log);this.showDrawInfo(this.drawing_log);if(this._first_drawing&&this._webgl&&(this._num_meshes-this._last_render_meshes>100)&&(h-this._last_render_tm>2.5*f)){this.adjustCameraPosition();this.Render3D(-1);this._last_render_tm=new Date().getTime();this._last_render_meshes=this._num_meshes}if(i!==2){setTimeout(this.continueDraw.bind(this),(i===1)?100:1)}return}}var j=h-this._startm;if(this._first_drawing){a.console("Create tm = "+j+" meshes "+this._num_meshes+" faces "+this._num_faces)}if(j>300){a.progress("Rendering geometry");this.showDrawInfo("Rendering");return setTimeout(this.completeDraw.bind(this,true),10)}this.completeDraw(true)};c.prototype.TestCameraPosition=function(){this._camera.updateMatrixWorld();var f=this._camera.position.clone();if(this._last_camera_position){var g=this._last_camera_position.distanceTo(f);if(g<(this._overall_size||1000)/10000){return}}this._last_camera_position=f;if(this._webgl){a.GEO.produceRenderOrder(this._toplevel,f,this.options.depthMethod,this._clones)}};c.prototype.Render3D=function(i,h){if(!this._renderer){console.warn("renderer object not exists - check code");return}if(i===undefined){i=5}if((i<=0)||this._usesvg){if("render_tmout" in this){clearTimeout(this.render_tmout)}else{if(i===-2222){return}}var g=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this._camera,this._toplevel)}this.TestCameraPosition();if(this._webgl&&this._enableSSAO){this._scene.overrideMaterial=this._depthMaterial;this._renderer.render(this._scene,this._camera,this._depthRenderTarget,true);this._scene.overrideMaterial=null;this._effectComposer.render()}else{this._renderer.render(this._scene,this._camera)}var f=new Date();this.last_render_tm=f.getTime()-g.getTime();delete this.render_tmout;if((this.first_render_tm===0)&&h){this.first_render_tm=this.last_render_tm;a.console("First render tm = "+this.first_render_tm)}if(this._renderer.workaround_id!==undefined){a.svg_workaround[this._renderer.workaround_id]=this._renderer.outerHTML}return}if(!this.render_tmout){this.render_tmout=setTimeout(this.Render3D.bind(this,0,h),i)}};c.prototype.startWorker=function(){if(this._worker){return}this._worker_ready=false;this._worker_jobs=0;var f=this;this._worker=new Worker(a.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(g){if(typeof g.data!=="object"){return}if("log" in g.data){return a.console("geo: "+g.data.log)}if("progress" in g.data){return a.progress(g.data.progress)}g.data.tm3=new Date().getTime();if("init" in g.data){f._worker_ready=true;return a.console("Worker ready: "+(g.data.tm3-g.data.tm0))}f.processWorkerReply(g.data)};this._worker.postMessage({init:true,browser:a.browser,tm0:new Date().getTime(),clones:this._clones.nodes,sortmap:this._clones.sortmap})};c.prototype.canSubmitToWorker=function(f){if(!this._worker){return false}return this._worker_ready&&((this._worker_jobs==0)||f)};c.prototype.submitToWorker=function(f){if(!this._worker){return false}this._worker_jobs++;f.tm0=new Date().getTime();this._worker.postMessage(f)};c.prototype.processWorkerReply=function(h){this._worker_jobs--;if("collect" in h){this._new_draw_nodes=h.new_nodes;this._draw_all_nodes=h.complete;this.drawing_stage=3;return this.continueDraw()}if("shapes" in h){for(var i=0;i<h.shapes.length;++i){var g=h.shapes[i],f=this._build_shapes[i];if(g.buf_pos&&g.buf_norm){if(g.buf_pos.length===0){f.geom=null}else{if(g.buf_pos.length!==g.buf_norm.length){console.error("item.buf_pos",g.buf_pos.length,"item.buf_norm",g.buf_norm.length);f.geom=null}else{f.geom=new e.BufferGeometry();f.geom.addAttribute("position",new e.BufferAttribute(g.buf_pos,3));f.geom.addAttribute("normal",new e.BufferAttribute(g.buf_norm,3))}}f.ready=true;f.nfaces=g.nfaces}}h.tm4=new Date().getTime();this.drawing_stage=7;return this.continueDraw()}};c.prototype.testGeomChanges=function(){if(this._main_painter){console.warn("Get testGeomChanges call for slave painter");return this._main_painter.testGeomChanges()}this.startDrawGeometry();for(var f=0;f<this._slave_painters.length;++f){this._slave_painters[f].startDrawGeometry()}};c.prototype.drawSimpleAxis=function(){var h=this.getGeomBoundingBox(this._toplevel);this.getExtrasContainer("delete","axis");var i=this.getExtrasContainer("create","axis");var g=0.02*Math.max((h.max.x-h.min.x),(h.max.y-h.min.y),(h.max.z-h.min.z)),j=["x","y","z"],u=[0,0,0];if(this.options._axis_center){for(var w=0;w<3;++w){var x=j[w];if((h.min[x]<=0)&&(h.max[x]>=0)){continue}u[w]=(h.min[x]+h.max[x])/2}}for(var w=0;w<3;++w){var t=new Float32Array(6),n,x=j[w];function v(y){var k=h.max[x]-h.min[x];if(k<2){return y.toFixed(3)}if(Math.abs(y)>100000){return y.toExponential(3)}return Math.round(y).toString()}var q=v(h.max[x]);t[0]=h.min.x;t[1]=h.min.y;t[2]=h.min.z;t[3]=h.min.x;t[4]=h.min.y;t[5]=h.min.z;switch(w){case 0:t[3]=h.max.x;n="red";if(this.options._yup){q="X "+q}else{q+=" X"}break;case 1:t[4]=h.max.y;n="green";if(this.options._yup){q+=" Y"}else{q="Y "+q}break;case 2:t[5]=h.max.z;n="blue";q+=" Z";break}if(this.options._axis_center){for(var o=0;o<6;++o){if((o%3)!==w){t[o]=u[o%3]}}}var s=new e.LineBasicMaterial({color:n}),f=a.Painter.createLineSegments(t,s);i.add(f);var p=new e.MeshBasicMaterial({color:n});if((u[w]===0)&&(u[w]>=h.min[x])&&(u[w]<=h.max[x])){if(!this.options._axis_center||(w===0)){var m=new e.SphereBufferGeometry(g*0.25);f=new e.Mesh(m,p);f.translateX((w===0)?u[0]:t[0]);f.translateY((w===1)?u[1]:t[1]);f.translateZ((w===2)?u[2]:t[2]);i.add(f)}}var r=new e.TextGeometry(q,{font:a.threejs_font_helvetiker_regular,size:g,height:0,curveSegments:5});f=new e.Mesh(r,p);var l=new e.Box3().setFromObject(f);f.translateX(t[3]);f.translateY(t[4]);f.translateZ(t[5]);if(this.options._yup){switch(w){case 0:f.rotateY(Math.PI);f.translateX(-l.max.x-g*0.5);f.translateY(-l.max.y/2);break;case 1:f.rotateX(-Math.PI/2);f.rotateY(-Math.PI/2);f.translateX(g*0.5);f.translateY(-l.max.y/2);break;case 2:f.rotateY(-Math.PI/2);f.translateX(g*0.5);f.translateY(-l.max.y/2);break}}else{switch(w){case 0:f.rotateX(Math.PI/2);f.translateY(-l.max.y/2);f.translateX(g*0.5);break;case 1:f.rotateX(Math.PI/2);f.rotateY(-Math.PI/2);f.translateX(-l.max.x-g*0.5);f.translateY(-l.max.y/2);break;case 2:f.rotateX(Math.PI/2);f.rotateZ(Math.PI/2);f.translateX(g*0.5);f.translateY(-l.max.y/2);break}}i.add(f);r=new e.TextGeometry(v(h.min[x]),{font:a.threejs_font_helvetiker_regular,size:g,height:0,curveSegments:5});f=new e.Mesh(r,p);l=new e.Box3().setFromObject(f);f.translateX(t[0]);f.translateY(t[1]);f.translateZ(t[2]);if(this.options._yup){switch(w){case 0:f.rotateY(Math.PI);f.translateX(g*0.5);f.translateY(-l.max.y/2);break;case 1:f.rotateX(-Math.PI/2);f.rotateY(-Math.PI/2);f.translateY(-l.max.y/2);f.translateX(-l.max.x-g*0.5);break;case 2:f.rotateY(-Math.PI/2);f.translateX(-l.max.x-g*0.5);f.translateY(-l.max.y/2);break}}else{switch(w){case 0:f.rotateX(Math.PI/2);f.translateX(-l.max.x-g*0.5);f.translateY(-l.max.y/2);break;case 1:f.rotateX(Math.PI/2);f.rotateY(-Math.PI/2);f.translateY(-l.max.y/2);f.translateX(g*0.5);break;case 2:f.rotateX(Math.PI/2);f.rotateZ(Math.PI/2);f.translateX(-l.max.x-g*0.5);f.translateY(-l.max.y/2);break}}i.add(f)}this.TestAxisVisibility=function(y,k){if(!y){this.getExtrasContainer("delete","axis");delete this.TestAxisVisibility;this.Render3D();return}}};c.prototype.toggleAxisDraw=function(f){if(this.TestAxisVisibility){if(!f){this.TestAxisVisibility(null,this._toplevel)}}else{this.drawSimpleAxis()}};c.prototype.completeDraw=function(f){var g=false;if(!this.options){console.warn("options object does not exist in completeDraw - something went wrong");return}if(this._first_drawing){this.adjustCameraPosition(true);this.showDrawInfo();this._first_drawing=false;g=true;if(this._webgl){this.enableX=this.options.clipx;this.enableY=this.options.clipy;this.enableZ=this.options.clipz;this.updateClipping(true)}if(this.options.tracks&&this.geo_manager&&this.geo_manager.fTracks){this.addExtra(this.geo_manager.fTracks,"<prnt>/Tracks")}}if(this.options.transparency!==0){this.changeGlobalTransparency(this.options.transparency,true)}this.completeScene();if(this.options._axis){this.toggleAxisDraw(true)}this._scene.overrideMaterial=null;this.getExtrasContainer("delete");var h=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects;this.drawExtras(h);this.Render3D(0,true);if(f){a.progress()}this.addOrbitControls();this.addTransformControl();if(g){if(this.options.highlight===false){this.options.highlight=(this.first_render_tm<1000)}if(this._webgl&&this.options.autoRotate&&!this.options.project){this.autorotate(2.5)}if(!this._usesvg&&this.options.show_controls){this.showControlOptions(true)}this.DrawingReady()}if(this._draw_nodes_again){return this.startDrawGeometry()}this._drawing_ready=true};c.prototype.Cleanup=function(i){if(!i){this.AccessTopPainter(false);this.helpText();a.Painter.DisposeThreejsObject(this._scene);a.Painter.DisposeThreejsObject(this._full_geom);if(this._tcontrols){this._tcontrols.dispose()}if(this._controls){this._controls.Cleanup()}if(this._context_menu){this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,false)}if(this._datgui){this._datgui.destroy()}if(this._worker){this._worker.terminate()}a.TObjectPainter.prototype.Cleanup.call(this);delete this.options;delete this._animating;var h=this.GetGeometry();if(h&&this.options.is_main){if(h.$geo_painter===this){delete h.$geo_painter}else{if(h.fVolume&&h.fVolume.$geo_painter===this){delete h.fVolume.$geo_painter}}}if(this._main_painter){var j=this._main_painter._slave_painters.indexOf(this);if(j>=0){this._main_painter._slave_painters.splice(j,1)}}for(var g=0;g<this._slave_painters.length;++g){var f=this._slave_painters[g];if(f&&(f._main_painter===this)){f._main_painter=null}}}for(var g in this._slave_painters){var f=this._slave_painters[g];f._main_painter=null;if(f._clones===this._clones){f._clones=null}}this._main_painter=null;this._slave_painters=[];if(this._renderer){if(this._renderer.dispose){this._renderer.dispose()}if(this._renderer.context){delete this._renderer.context}}delete this._scene;this._scene_width=0;this._scene_height=0;this._renderer=null;this._toplevel=null;this._full_geom=null;this._camera=null;this._selected_mesh=null;if(this._clones&&this._clones_owner){this._clones.Cleanup(this._draw_nodes,this._build_shapes)}delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;this.first_render_tm=0;this.last_render_tm=2000;this.drawing_stage=0;delete this.drawing_log;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};c.prototype.helpText=function(f){a.progress(f)};c.prototype.CheckResize=function(f){var g=this.pad_painter();if(g){if(!g.CheckCanvasResize(f)){return false}}var h=this.size_for_3d();if((this._scene_width===h.width)&&(this._scene_height===h.height)){return false}if((h.width<10)||(h.height<10)){return}this._scene_width=h.width;this._scene_height=h.height;this._camera.aspect=this._scene_width/this._scene_height;this._camera.updateProjectionMatrix();this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area);this.Render3D();return true};c.prototype.ToggleEnlarge=function(){if(d.event){d.event.preventDefault();d.event.stopPropagation()}if(this.enlarge_main("toggle")){this.CheckResize()}};c.prototype.ownedByTransformControls=function(g){var f=g.parent;while(f&&!(f instanceof e.TransformControls)){f=f.parent}return(f&&(f instanceof e.TransformControls))};c.prototype.accessObjectWireFrame=function(g,f){if(!g.hasOwnProperty("material")||(g instanceof e.GridHelper)){return}if(this.ownedByTransformControls(g)){return}if((f!==undefined)&&g.stack){g.material.wireframe=f}return g.material.wireframe};c.prototype.changeWireFrame=function(h,g){var f=this;h.traverse(function(i){f.accessObjectWireFrame(i,g)});this.Render3D()};a.Painter.drawGeoObject=function(k,i,h){if(!i){return null}a.GEO.GradPerSegm=a.gStyle.GeoGradPerSegm;a.GEO.CompressComp=a.gStyle.GeoCompressComp;var g=null,j=false;if(("fShapeBits" in i)&&("fShapeId" in i)){g=i;i=null}else{if((i._typename==="TGeoVolumeAssembly")||(i._typename==="TGeoVolume")){g=i.fShape}else{if(i._typename==="TEveGeoShapeExtract"){g=i.fShape}else{if(i._typename==="TGeoManager"){a.GEO.SetBit(i.fMasterVolume,a.GEO.BITS.kVisThis,false);g=i.fMasterVolume.fShape;j=true}else{if("fVolume" in i){if(i.fVolume){g=i.fVolume.fShape}}else{i=null}}}}}if(h&&h.indexOf("comp")==0&&g&&(g._typename=="TGeoCompositeShape")&&g.fNode){h=h.substr(4);i=a.GEO.buildCompositeVolume(g)}if(!i&&g){i=a.extend(a.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:g,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:true})}if(!i){return null}var f=new c(i,j);f.SetDivId(k,5);f._usesvg=a.BatchMode;f._webgl=!f._usesvg&&a.Painter.TestWebGL();f.options=f.decodeOptions(h);if(f.options._yup===undefined){f.options._yup=f.svg_canvas().empty()}if(f.options.is_main&&!i.$geo_painter){i.$geo_painter=f}if(!f.options.is_main&&f.options.project&&i.$geo_painter){f._main_painter=i.$geo_painter;f._main_painter._slave_painters.push(f)}f.checkScript(f.options.script_name,f.prepareObjectDraw.bind(f));return f};a.Painter.drawGeometry=a.Painter.drawGeoObject;a.GEO.buildCompositeVolume=function(h,j){var i=a.Create("TGeoVolume");if(j&&(h._typename!=="TGeoCompositeShape")){i.fName=j;a.GEO.SetBit(i,a.GEO.BITS.kVisThis,true);i.fLineColor=(j=="Left"?2:3);i.fShape=h;return i}a.GEO.SetBit(i,a.GEO.BITS.kVisDaughters,true);i.$geoh=true;i.fName="";var g=a.Create("TGeoNodeMatrix");g.fName="Left";g.fMatrix=h.fNode.fLeftMat;g.fVolume=a.GEO.buildCompositeVolume(h.fNode.fLeft,"Left");var f=a.Create("TGeoNodeMatrix");f.fName="Right";f.fMatrix=h.fNode.fRightMat;f.fVolume=a.GEO.buildCompositeVolume(h.fNode.fRight,"Right");i.fNodes=a.Create("TList");i.fNodes.Add(g);i.fNodes.Add(f);return i};a.GEO.provideVisStyle=function(h){if(h._typename==="TEveGeoShapeExtract"){return h.fRnrSelf?" geovis_this":""}var g=!a.GEO.TestBit(h,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(h,a.GEO.BITS.kVisThis);var f=a.GEO.TestBit(h,a.GEO.BITS.kVisDaughters)||a.GEO.TestBit(h,a.GEO.BITS.kVisOneLevel);if(f&&(!h.fNodes||(h.fNodes.arr.length===0))){f=false}if(g&&f){return" geovis_all"}if(g){return" geovis_this"}if(f){return" geovis_daughters"}return""};a.GEO.getBrowserItem=function(f,h,g){if(f._geoobj){f._geoobj.$geoh=true}a.CallBack(g,f,f._geoobj)};a.GEO.createItem=function(k,m,g){var i={_kind:"ROOT."+m._typename,_name:g?g:a.GEO.ObjectName(m),_title:m.fTitle,_parent:k,_geoobj:m,_get:a.GEO.getBrowserItem};var j,f,l,h=false;if(m._typename=="TGeoMaterial"){i._icon="img_geomaterial"}else{if(m._typename=="TGeoMedium"){i._icon="img_geomedium"}else{if(m._typename=="TGeoMixture"){i._icon="img_geomixture"}else{if((m._typename.indexOf("TGeoNode")===0)&&m.fVolume){i._title="node:"+m._typename;if(m.fTitle.length>0){i._title+=" "+m.fTitle}j=m.fVolume}else{if(m._typename.indexOf("TGeoVolume")===0){j=m}else{if(m._typename=="TEveGeoShapeExtract"){h=true;f=m.fShape;l=m.fElements?m.fElements.arr:null}else{if((m.fShapeBits!==undefined)&&(m.fShapeId!==undefined)){f=m}}}}}}}if(j){f=j.fShape;l=j.fNodes?j.fNodes.arr:null}if(j||f||l){if(j){i._volume=j}if(l){i._more=true;i._expand=a.GEO.expandObject}else{if(f&&(f._typename==="TGeoCompositeShape")&&f.fNode){i._more=true;i._shape=f;i._expand=function(n,o){a.GEO.createItem(n,n._shape.fNode.fLeft,"Left");a.GEO.createItem(n,n._shape.fNode.fRight,"Right");return true}}}if(!i._title&&(m._typename!="TGeoVolume")){i._title=m._typename}if(f){if(i._title==""){i._title=f._typename}i._icon=a.GEO.getShapeIcon(f)}else{i._icon=i._more?"img_geocombi":"img_geobbox"}if(j){i._icon+=a.GEO.provideVisStyle(j)}else{if(h){i._icon+=a.GEO.provideVisStyle(m)}}i._menu=a.GEO.provideMenu;i._icon_click=a.GEO.browserIconClick}if(!k._childs){k._childs=[]}if(!i._name){if(typeof k._name==="string"){i._name=k._name;if(i._name.lastIndexOf("s")===i._name.length-1){i._name=i._name.substr(0,i._name.length-1)}i._name+="_"+k._childs.length}else{i._name="item_"+k._childs.length}}k._childs.push(i);return i};a.GEO.createList=function(h,f,g,j){if((f==null)||!("arr" in f)||(f.arr.length==0)){return}var i={_name:g,_kind:"ROOT.TList",_title:j,_more:true,_geoobj:f,_parent:h};i._get=function(k,m,l){if("_geoobj" in k){return a.CallBack(l,k,k._geoobj)}a.CallBack(l,k,null)};i._expand=function(l,k){if("fVolume" in k){k=k.fVolume.fNodes}if(!("arr" in k)){return false}l._childs=[];a.GEO.CheckDuplicates(null,k.arr);for(var m in k.arr){a.GEO.createItem(l,k.arr[m])}return true};if(!h._childs){h._childs=[]}h._childs.push(i)};a.GEO.provideMenu=function(f,n,g){if(!n._geoobj){return false}var j=n._geoobj,h=n._volume,i=(j._typename==="TEveGeoShapeExtract");if(!h&&!i){return false}f.add("separator");function o(r,q,p){if(!q){q={visible:0,hidden:0}}if(!p){if(q.assign!==undefined){r.fRnrSelf=q.assign}else{if(r.fRnrSelf){q.vis++}else{q.hidden++}}}if(r.fElements){for(var s=0;s<r.fElements.arr.length;++s){o(r.fElements.arr[s],q,false)}}return q}function k(p){if(p==="self"){j.fRnrSelf=!j.fRnrSelf;n._icon=n._icon.split(" ")[0]+a.GEO.provideVisStyle(j);g.UpdateTreeNode(n)}else{o(j,{assign:(p==="true")},true);g.ForEach(function(q){if(q._geoobj&&q._icon){q._icon=n._icon.split(" ")[0]+a.GEO.provideVisStyle(q._geoobj);g.UpdateTreeNode(q)}},n)}a.GEO.findItemWithPainter(n,"testGeomChanges")}function m(p){a.GEO.ToggleBit(h,p);var q=n._icon.split(" ")[0]+a.GEO.provideVisStyle(h);g.ForEach(function(r){if(n._volume===r._volume){r._icon=q;g.UpdateTreeNode(r)}});g.UpdateTreeNode(n);a.GEO.findItemWithPainter(n,"testGeomChanges")}if((n._geoobj._typename.indexOf("TGeoNode")===0)&&a.GEO.findItemWithPainter(n)){f.add("Focus",function(){var q=a.GEO.findItemWithPainter(n);if(!q){return}var p=g.itemFullName(n,q);if(q._painter&&typeof q._painter.focusOnItem=="function"){q._painter.focusOnItem(p)}})}if(i){f.addchk(j.fRnrSelf,"Visible","self",k);var l=o(j,undefined,true);if(l.hidden+l.visible>0){f.addchk((l.hidden==0),"Daughters",(l.hidden!=0)?"true":"false",k)}}else{f.addchk(a.GEO.TestBit(h,a.GEO.BITS.kVisNone),"Invisible",a.GEO.BITS.kVisNone,m);f.addchk(a.GEO.TestBit(h,a.GEO.BITS.kVisThis),"Visible",a.GEO.BITS.kVisThis,m);f.addchk(a.GEO.TestBit(h,a.GEO.BITS.kVisDaughters),"Daughters",a.GEO.BITS.kVisDaughters,m);f.addchk(a.GEO.TestBit(h,a.GEO.BITS.kVisOneLevel),"1lvl daughters",a.GEO.BITS.kVisOneLevel,m)}return true};a.GEO.findItemWithPainter=function(g,f){while(g){if(g._painter&&g._painter._camera){if(f&&typeof g._painter[f]=="function"){g._painter[f]()}return g}g=g._parent}return null};a.GEO.updateBrowserIcons=function(g,f){if(!g||!f){return}f.ForEach(function(h){if((g===h._volume)||(g===h._geoobj)){h._icon=h._icon.split(" ")[0]+a.GEO.provideVisStyle(g);f.UpdateTreeNode(h)}})};a.GEO.browserIconClick=function(g,i){if(g._volume){if(g._more&&g._volume.fNodes&&(g._volume.fNodes.arr.length>0)){a.GEO.ToggleBit(g._volume,a.GEO.BITS.kVisDaughters)}else{a.GEO.ToggleBit(g._volume,a.GEO.BITS.kVisThis)}a.GEO.updateBrowserIcons(g._volume,i);a.GEO.findItemWithPainter(g,"testGeomChanges");return false}if(g._geoobj&&g._geoobj._typename=="TEveGeoShapeExtract"){g._geoobj.fRnrSelf=!g._geoobj.fRnrSelf;a.GEO.updateBrowserIcons(g._geoobj,i);a.GEO.findItemWithPainter(g,"testGeomChanges");return false}var h=a.GEO.findItemWithPainter(g);if(!h){return false}var f=h._painter.ExtraObjectVisible(i,g,true);return(f!==undefined)?true:false};a.GEO.getShapeIcon=function(f){switch(f._typename){case"TGeoArb8":return"img_geoarb8";break;case"TGeoCone":return"img_geocone";break;case"TGeoConeSeg":return"img_geoconeseg";break;case"TGeoCompositeShape":return"img_geocomposite";break;case"TGeoTube":return"img_geotube";break;case"TGeoTubeSeg":return"img_geotubeseg";break;case"TGeoPara":return"img_geopara";break;case"TGeoParaboloid":return"img_geoparab";break;case"TGeoPcon":return"img_geopcon";break;case"TGeoPgon":return"img_geopgon";break;case"TGeoShapeAssembly":return"img_geoassembly";break;case"TGeoSphere":return"img_geosphere";break;case"TGeoTorus":return"img_geotorus";break;case"TGeoTrd1":return"img_geotrd1";break;case"TGeoTrd2":return"img_geotrd2";break;case"TGeoXtru":return"img_geoxtru";break;case"TGeoTrap":return"img_geotrap";break;case"TGeoGtra":return"img_geogtra";break;case"TGeoEltu":return"img_geoeltu";break;case"TGeoHype":return"img_geohype";break;case"TGeoCtub":return"img_geoctub";break}return"img_geotube"};a.GEO.getBrowserIcon=function(f,i){var g="";if(f._kind=="ROOT.TEveTrack"){g="img_evetrack"}else{if(f._kind=="ROOT.TEvePointSet"){g="img_evepoints"}else{if(f._kind=="ROOT.TPolyMarker3D"){g="img_evepoints"}}}if(g.length>0){var h=a.GEO.findItemWithPainter(f);if(h){if(h._painter.ExtraObjectVisible(i,f)){g+=" geovis_this"}}}return g};a.GEO.expandObject=function(p,l){if(!p||!l){return false}var m=(l._typename.indexOf("TGeoNode")===0),g=(l._typename.indexOf("TGeoVolume")===0),h=(l._typename==="TGeoManager"),j=(l._typename==="TEveGeoShapeExtract");if(!m&&!g&&!h&&!j){return false}if(p._childs){return true}if(h){a.GEO.createList(p,l.fMaterials,"Materials","list of materials");a.GEO.createList(p,l.fMedia,"Media","list of media");a.GEO.createList(p,l.fTracks,"Tracks","list of tracks");a.GEO.SetBit(l.fMasterVolume,a.GEO.BITS.kVisThis,false);a.GEO.createItem(p,l.fMasterVolume);return true}var n,f,o;if(j){f=l.fElements?l.fElements.arr:null;o=l.fShape}else{n=(m?l.fVolume:l);f=n&&n.fNodes?n.fNodes.arr:null;o=n?n.fShape:null}if(!f&&o&&(o._typename==="TGeoCompositeShape")&&o.fNode){if(!p._childs){a.GEO.createItem(p,o.fNode.fLeft,"Left");a.GEO.createItem(p,o.fNode.fRight,"Right")}return true}if(!f){return false}a.GEO.CheckDuplicates(l,f);for(var k=0;k<f.length;++k){a.GEO.createItem(p,f[k])}return true};a.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:a.Painter.drawGeoObject,expand:a.GEO.expandObject,opt:";more;all;count"});a.addDrawFunc({name:"TEvePointSet",icon_get:a.GEO.getBrowserIcon,icon_click:a.GEO.browserIconClick});a.addDrawFunc({name:"TEveTrack",icon_get:a.GEO.getBrowserIcon,icon_click:a.GEO.browserIconClick});a.TGeoPainter=c;return a.Painter}));