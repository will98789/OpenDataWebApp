(function(a){if(typeof define==="function"&&define.amd){define(["JSRootCore","d3","JSRootPainter.hist","threejs","threejs_all"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");a(b,require("./d3.min.js"),require("./JSRootPainter.hist.js"),require("./three.min.js"),require("./three.extra.min.js"),b.nodejs||(typeof document=="undefined")?b.nodejs_document:document)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootPainter.hist3d.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.js","JSRootPainter.hist3d.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(JSROOT,d3,JSROOT,THREE,THREE)}}}(function(a,i,b,f,g,d){a.sources.push("hist3d");if((typeof d=="undefined")&&(typeof window=="object")){d=window.document}if(typeof a.THistPainter==="undefined"){throw new Error("JSROOT.THistPainter is not defined","JSRootPainter.hist3d.js")}a.THistPainter.prototype.Create3DScene=function(q){if((q!==undefined)&&(q<0)){if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(null,this.toplevel)}this.clear_3d_canvas();a.Painter.DisposeThreejsObject(this.scene);if(this.control){this.control.Cleanup()}if(this.renderer){if(this.renderer.dispose){this.renderer.dispose()}if(this.renderer.context){delete this.renderer.context}}delete this.size_xy3d;delete this.size_z3d;delete this.scene;delete this.toplevel;delete this.tooltip_mesh;delete this.camera;delete this.pointLight;delete this.renderer;delete this.control;if("render_tmout" in this){clearTimeout(this.render_tmout);delete this.render_tmout}return}if("toplevel" in this){this.scene.remove(this.toplevel);a.Painter.DisposeThreejsObject(this.toplevel);delete this.toplevel;delete this.tooltip_mesh;if(this.control){this.control.HideTooltip()}var n=new f.Object3D();this.scene.add(n);this.toplevel=n;this.Resize3D();return}this.usesvg=a.BatchMode;var o=this.size_for_3d(this.usesvg?3:undefined);this.size_z3d=100;this.size_xy3d=(o.height>10)&&(o.width>10)?Math.round(o.width/o.height*this.size_z3d):this.size_z3d;this.scene=new f.Scene();this.toplevel=new f.Object3D();this.scene.add(this.toplevel);this.scene_width=o.width;this.scene_height=o.height;this.camera=new f.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);var k=Math.max(0.75*this.size_xy3d,this.size_z3d);this.camera.position.set(-1.6*k,-3.5*k,1.4*this.size_z3d);var l=this.root_pad();if(l&&(l.fTheta!==undefined)&&(l.fPhi!==undefined)&&(l.fTheta!==30)||(l.fPhi!==30)){k=3*Math.max(this.size_xy3d,this.size_z3d);var m=(-l.fPhi-90)/180*Math.PI,j=l.fTheta/180*Math.PI;this.camera.position.set(k*Math.cos(m)*Math.cos(j),k*Math.sin(m)*Math.cos(j),this.size_z3d+k*Math.sin(j))}this.pointLight=new f.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);var r=new f.Vector3(0,0,0.8*this.size_z3d);this.camera.up=new f.Vector3(0,0,1);this.camera.lookAt(r);this.scene.add(this.camera);if(this.usesvg){this.renderer=new f.SVGRenderer({precision:0,astext:true});if(this.renderer.outerHTML!==undefined){if(!a.svg_workaround){a.svg_workaround=[]}this.renderer.domElement=d.createElementNS("http://www.w3.org/2000/svg","path");this.renderer.workaround_id=a.svg_workaround.length;this.renderer.domElement.setAttribute("jsroot_svg_workaround",this.renderer.workaround_id);a.svg_workaround[this.renderer.workaround_id]="<svg></svg>"}}else{this.webgl=a.Painter.TestWebGL();this.renderer=this.webgl?new f.WebGLRenderer({antialias:true,alpha:true}):new f.CanvasRenderer({antialias:true,alpha:true})}this.renderer.setSize(this.scene_width,this.scene_height);this.add_3d_canvas(o,this.renderer.domElement);this.first_render_tm=0;this.enable_highlight=false;this.tooltip_allowed=(a.gStyle.Tooltip>0);if(a.BatchMode){return}this.control=a.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,r);var p=this;this.control.ProcessMouseMove=function(B){var C=null,D=null,u=null;for(var A=0;A<B.length;++A){if(B[A].object.tooltip){C=B[A].object.tooltip(B[A]);if(C){D=B[A].object;break}}else{if(B[A].object.zoom&&!u){u=B[A].object}}}if(C&&!C.use_itself){var v=0.0001*p.size_xy3d,w=0.0001*p.size_z3d;if((C.x1>C.x2)||(C.y1>C.y2)||(C.z1>C.z2)){console.warn("check 3D hints coordinates")}C.x1-=v;C.x2+=v;C.y1-=v;C.y2+=v;C.z1-=w;C.z2+=w}p.BinHighlight3D(C,D);if(!C&&u&&p.Get3DZoomCoord){var s=u.GlobalIntersect(this.raycaster),z=u.zoom,x=p.Get3DZoomCoord(s,z);if((z==="z")&&u.use_y_for_z){z="y"}var t=this.histo?this.histo["f"+z.toUpperCase()+"axis"]:null;var y={name:z,title:"TAxis",line:"any info",only_status:true};if(t){y.name=t.fName;y.title=t.fTitle||"histogram TAxis object"}y.line=z+" : "+p.AxisAsText(z,x);return y}return(C&&C.lines)?C:""};this.control.ProcessMouseLeave=function(){p.BinHighlight3D(null)};this.control.ContextMenu=function(x,t){var s="hist",u=p;if(t){for(var w=0;w<t.length;++w){var v=t[w].object;if(v.zoom){s=v.zoom;break}if(v.painter&&typeof v.painter.ShowContextMenu==="function"){u=v.painter;break}}}u.ShowContextMenu(s,x)}};a.THistPainter.prototype.Render3D=function(n){if(n===-1111){var m=new f.SVGRenderer({precision:0,astext:true});m.setSize(this.scene_width,this.scene_height);m.render(this.scene,this.camera);if(m.outerHTML){var l=d.createElement("div");l.innerHTML=m.outerHTML;return l.childNodes[0]}return m.domElement}if(n===undefined){n=5}if((n<=0)||this.usesvg){if("render_tmout" in this){clearTimeout(this.render_tmout)}else{if(n===-2222){return}}if(this.renderer===undefined){return}var k=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this.camera,this.toplevel,this.options.FrontBox,this.options.BackBox)}this.renderer.render(this.scene,this.camera);var j=new Date();delete this.render_tmout;if(this.first_render_tm===0){this.first_render_tm=j.getTime()-k.getTime();this.enable_highlight=(this.first_render_tm<1200)&&this.tooltip_allowed;console.log("First render tm = "+this.first_render_tm)}if(this.renderer.workaround_id!==undefined){a.svg_workaround[this.renderer.workaround_id]=this.renderer.outerHTML}return}if("render_tmout" in this){return}this.render_tmout=setTimeout(this.Render3D.bind(this,0),n)};a.THistPainter.prototype.Resize3D=function(){var j=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(j);if((this.scene_width===j.width)&&(this.scene_height===j.height)){return false}if((j.width<10)||(j.height<10)){return false}this.scene_width=j.width;this.scene_height=j.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return true};a.THistPainter.prototype.BinHighlight3D=function(t,m){var r=false,u=null,s=true,w=!t||(t.x1===undefined)||!this.enable_highlight;if(this.tooltip_selfmesh){s=(this.tooltip_selfmesh!==m);this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color;delete this.tooltip_selfmesh;r=true}if(this.tooltip_mesh){u=this.tooltip_mesh;this.toplevel.remove(this.tooltip_mesh);delete this.tooltip_mesh;r=true}if(w){if(r){this.Render3D()}this.ProvideUserTooltip(null);return}if(t.use_itself){m.save_color=m.material.color;m.material.color=new f.Color(t.color);this.tooltip_selfmesh=m;r=s}else{r=true;var j=a.Painter.Box3D.Indexes,v=a.Painter.Box3D.Normals,q=a.Painter.Box3D.Vertices,p,o,y=new f.Color(t.color?t.color:16711680),n=t.opacity||1;if(!u){p=new Float32Array(j.length*3);o=new Float32Array(j.length*3);var x=new f.BufferGeometry();x.addAttribute("position",new f.BufferAttribute(p,3));x.addAttribute("normal",new f.BufferAttribute(o,3));var B=new f.MeshBasicMaterial({color:y,opacity:n,shading:f.SmoothShading});u=new f.Mesh(x,B)}else{p=u.geometry.attributes.position.array;u.geometry.attributes.position.needsUpdate=true;u.material.color=y;u.material.opacity=n}if(t.x1===t.x2){console.warn("same tip X",t.x1,t.x2)}if(t.y1===t.y2){console.warn("same tip Y",t.y1,t.y2)}if(t.z1===t.z2){t.z2=t.z1+0.0001}for(var z=0,l=-3;z<j.length;++z){var A=q[j[z]];p[z*3]=t.x1+A.x*(t.x2-t.x1);p[z*3+1]=t.y1+A.y*(t.y2-t.y1);p[z*3+2]=t.z1+A.z*(t.z2-t.z1);if(o){if(z%6===0){l+=3}o[z*3]=v[l];o[z*3+1]=v[l+1];o[z*3+2]=v[l+2]}}this.tooltip_mesh=u;this.toplevel.add(u)}if(r){this.Render3D()}if(this.IsUserTooltipCallback()&&this.GetObject()){this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:t.bin,cont:t.value,binx:t.ix,biny:t.iy,binz:t.iz,grx:(t.x1+t.x2)/2,gry:(t.y1+t.y2)/2,grz:(t.z1+t.z2)/2})}};function c(p,u,l,r){var t;for(var k=0;k<u.children.length;++k){t=u.children[k];if(t.axis_draw){break}t=undefined}if(!t){return}if(!p){u.remove(t);delete this.TestAxisVisibility;return}l=l?true:false;r=r?true:false;var q=1,s=p.position;if((s.x<0)&&(s.y>=0)){q=2}if((s.x>=0)&&(s.y>=0)){q=3}if((s.x>=0)&&(s.y<0)){q=4}function m(w,n){if(w<=q){w+=4}return(w>q)&&(w<q+n)}for(var k=0;k<t.children.length;++k){var v=t.children[k];if(v.grid){v.visible=r&&m(v.grid,3)}else{if(v.zid){v.visible=m(v.zid,2)}else{if(v.xyid){v.visible=m(v.xyid,3)}else{if(v.xyboxid){var o=5,j=0;if(r&&!l){o=3;j=-2}else{if(l&&!r){o=3}else{if(!l&&!r){o=(v.bottom?3:0)}}}v.visible=m(v.xyboxid+j,o);if(!v.visible&&v.bottom&&r){v.visible=m(v.xyboxid,3)}}else{if(v.zboxid){var o=2,j=0;if(l&&r){o=5}else{if(r&&!l){o=4}else{if(!r&&l){j=-2;o=4}}}v.visible=m(v.zboxid+j,o)}}}}}}}a.THistPainter.prototype.DrawXYZ=function(I,Z){if(!Z){Z={}}var Q=-this.size_xy3d,p=this.size_xy3d,P=-this.size_xy3d,o=this.size_xy3d,N=0,k=2*this.size_z3d,ak=Math.round(this.size_z3d*0.05),K=this.root_pad(),H=this.histo,y=this.xmin,an=this.xmax,ah=this.ymin,r=this.ymax,l=this.zmin,aa=this.zmax,A=false,F=false;if(!this.size_z3d){Q=this.xmin;p=this.xmax;P=this.ymin;o=this.ymax;N=this.zmin;k=this.zmax;ak=(k-N)*0.05}if(("zoom_xmin" in this)&&("zoom_xmax" in this)&&(this.zoom_xmin!==this.zoom_xmax)){y=this.zoom_xmin;an=this.zoom_xmax}if(("zoom_ymin" in this)&&("zoom_ymax" in this)&&(this.zoom_ymin!==this.zoom_ymax)){ah=this.zoom_ymin;r=this.zoom_ymax;A=true}if(("zoom_zmin" in this)&&("zoom_zmax" in this)&&(this.zoom_zmin!==this.zoom_zmax)){l=this.zoom_zmin;aa=this.zoom_zmax;F=true}if(Z.use_y_for_z){this.zmin=this.ymin;this.zmax=this.ymax;l=ah;aa=r;F=A;ah=0;r=1}this.lego_zmin=l;this.lego_zmax=aa;if((Z.zmult!==undefined)&&!F){aa*=Z.zmult}this.TestAxisVisibility=c;if(K&&K.fLogx){if(an<=0){an=1}if((y<=0)&&(this.nbinsx>0)){for(var aw=0;aw<this.nbinsx;++aw){y=Math.max(y,this.GetBinX(aw));if(y>0){break}}}if(y<=0){y=0.0001*an}this.grx=i.scaleLog();this.x_kind="log"}else{this.grx=i.scaleLinear();if(H&&H.fXaxis.fLabels){this.x_kind="labels"}else{this.x_kind="normal"}}this.logx=(this.x_kind==="log");this.grx.domain([y,an]).range([Q,p]);this.x_handle=new a.TAxisPainter(H?H.fXaxis:null);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,y,an);this.x_handle.CreateFormatFuncs();this.scale_xmin=y;this.scale_xmax=an;if(K&&K.fLogy&&!Z.use_y_for_z){if(r<=0){r=1}if((ah<=0)&&(this.nbinsy>0)){for(var aw=0;aw<this.nbinsy;++aw){ah=Math.max(ah,this.GetBinY(aw));if(ah>0){break}}}if(ah<=0){ah=0.0001*r}this.gry=i.scaleLog();this.y_kind="log"}else{this.gry=i.scaleLinear();if(H&&H.fYaxis.fLabels){this.y_kind="labels"}else{this.y_kind="normal"}}this.logy=(this.y_kind==="log");this.gry.domain([ah,r]).range([P,o]);this.y_handle=new a.TAxisPainter(H?H.fYaxis:null);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,ah,r);this.y_handle.CreateFormatFuncs();this.scale_ymin=ah;this.scale_ymax=r;if(K&&K.fLogz){if(aa<=0){aa=1}if(l<=0){l=0.0001*aa}this.grz=i.scaleLog();this.z_kind="log"}else{this.grz=i.scaleLinear();this.z_kind="normal"}this.logz=(this.z_kind==="log");this.grz.domain([l,aa]).range([N,k]);this.SetRootPadRange(K,true);this.z_handle=new a.TAxisPainter(H?H.fZaxis:null);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,l,aa);this.z_handle.CreateFormatFuncs();this.scale_zmin=l;this.scale_zmax=aa;var G=new f.MeshBasicMaterial({color:0}),B=new f.LineBasicMaterial({color:0}),al=ak*0.5,ab,j,Y=[],V=1,aj=this.x_handle.CreateTicks(),w=this.y_handle.CreateTicks(),am=this.z_handle.CreateTicks();var s=new f.Object3D();s.axis_draw=true;I.add(s);var ap=[],ay=0,ag=H?H.fXaxis:null;while(aj.next()){var af=aj.grpos,at=(aj.kind===1),O=this.x_handle.format(aj.tick,true,true);if(aj.last_major()){if(!ag||!ag.fTitle){O="x"}}else{if(O===null){at=false;O=""}}if(at&&O&&(O.length>0)){var M=new f.TextGeometry(O,{font:a.threejs_font_helvetiker_regular,size:ak,height:0,curveSegments:5});M.computeBoundingBox();var D=M.boundingBox.max.x-M.boundingBox.min.x,C=M.boundingBox.max.y-M.boundingBox.min.y;M.center=true;ay=Math.max(ay,C);M.grx=af;Y.push(M);if(!aj.last_major()){var ax=(aj.next_major_grpos()-af);if(D>0){V=Math.min(V,0.9*ax/D)}if(this.x_handle.IsCenterLabels()){M.grx+=ax/2}}}ap.push(af,0,0,af,(at?-al:-al*0.6),0)}if(ag&&ag.fTitle){var M=new f.TextGeometry(ag.fTitle,{font:a.threejs_font_helvetiker_regular,size:ak,height:0,curveSegments:5});M.computeBoundingBox();M.center=(ag.TestBit(a.EAxisBits.kCenterTitle));M.gry=2;M.grx=(Q+p)/2;Y.push(M)}this.Get3DZoomCoord=function(n,aC){var aD=n[aC],aB=this["scale_"+aC+"min"],m=this["scale_"+aC+"max"];if(aC==="z"){aD=aD/2/this.size_z3d}else{aD=(aD+this.size_xy3d)/2/this.size_xy3d}if(this["log"+aC]){aD=Math.exp(Math.log(aB)+aD*(Math.log(m)-Math.log(aB)))}else{aD=aB+aD*(m-aB)}return aD};function ao(aB,aC,aE){var m=new f.Geometry();if(aB==="z"){m.vertices.push(new f.Vector3(0,0,0),new f.Vector3(al*4,0,0),new f.Vector3(al*4,0,2*aC),new f.Vector3(0,0,2*aC))}else{m.vertices.push(new f.Vector3(-aC,0,0),new f.Vector3(aC,0,0),new f.Vector3(aC,-al*4,0),new f.Vector3(-aC,-al*4,0))}m.faces.push(new f.Face3(0,2,1));m.faces.push(new f.Face3(0,3,2));m.computeFaceNormals();var n=new f.MeshBasicMaterial({transparent:true,vertexColors:f.NoColors,side:f.DoubleSide,opacity:0});var aD=new f.Mesh(m,n);aD.zoom=aB;aD.size_3d=aC;aD.use_y_for_z=aE;if(aB=="y"){aD.rotateZ(Math.PI/2).rotateX(Math.PI)}aD.GlobalIntersect=function(aH){var aG=new f.Plane(),aJ=this.geometry;aG.setFromCoplanarPoints(aJ.vertices[0],aJ.vertices[1],aJ.vertices[2]);aG.applyMatrix4(this.matrixWorld);var aM=aH.ray.origin.clone(),aL=aM.clone().addScaledVector(aH.ray.direction,10000000000);var aK=aG.intersectLine(new f.Line3(aM,aL));if(!aK){return undefined}var aI=-this.size_3d,aF=this.size_3d;if(this.zoom==="z"){aI=0;aF=2*this.size_3d}if(aK[this.zoom]<aI){aK[this.zoom]=aI}else{if(aK[this.zoom]>aF){aK[this.zoom]=aF}}return aK};aD.ShowSelection=function(aF,aJ){var aI=this.children[0],aG,aH=this.zoom;if(!aF||!aJ){if(aI){this.remove(aI);a.Painter.DisposeThreejsObject(aI)}return aI}if(!aI){aG=this.geometry.clone();if(aH==="z"){aG.vertices[1].x=aG.vertices[2].x=al}else{aG.vertices[2].y=aG.vertices[3].y=-al}aI=new f.Mesh(aG,new f.MeshBasicMaterial({color:65280,side:f.DoubleSide}));this.add(aI)}else{aG=aI.geometry}if(aH=="z"){aG.vertices[0].z=aG.vertices[1].z=aF[aH];aG.vertices[2].z=aG.vertices[3].z=aJ[aH]}else{aG.vertices[0].x=aG.vertices[3].x=aF[aH];aG.vertices[1].x=aG.vertices[2].x=aJ[aH]}aG.computeFaceNormals();aG.verticesNeedUpdate=true;aG.normalsNeedUpdate=true;return true};return aD}var aq=new f.Object3D();aq.position.set(0,P,N);aq.rotation.x=1/4*Math.PI;aq.xyid=2;var z=a.Painter.createLineSegments(ap,B);aq.add(z);Y.forEach(function(aD){var aC=aD.boundingBox.max.x-aD.boundingBox.min.x,aB=aD.center?aD.grx-aC/2:p-aC,n=new f.Matrix4();n.set(V,0,0,aB,0,V,0,(-ay*V-1.5*al)*(aD.gry||1),0,0,1,0,0,0,0,1);var aE=new f.Mesh(aD,G);aE.applyMatrix(n);aq.add(aE)});if(Z.zoom){aq.add(ao("x",this.size_xy3d))}s.add(aq);aq=new f.Object3D();aq.position.set(0,o,N);aq.rotation.x=3/4*Math.PI;aq.add(new f.LineSegments(z.geometry,B));Y.forEach(function(aD){var aC=aD.boundingBox.max.x-aD.boundingBox.min.x,aB=aD.center?aD.grx+aC/2:p,n=new f.Matrix4();n.set(-V,0,0,aB,0,V,0,(-ay*V-1.5*al)*(aD.gry||1),0,0,-1,0,0,0,0,1);var aE=new f.Mesh(aD,G);aE.applyMatrix(n);aq.add(aE)});aq.xyid=4;if(Z.zoom){aq.add(ao("x",this.size_xy3d))}s.add(aq);Y=[];V=1;ay=0;ap=[];var L=H?H.fYaxis:null;while(w.next()){var ae=w.grpos,at=(w.kind===1),O=this.y_handle.format(w.tick,true,true);if(w.last_major()){if(!L||!L.fTitle){O="y"}}else{if(O===null){at=false;O=""}}if(at){var M=new f.TextGeometry(O,{font:a.threejs_font_helvetiker_regular,size:ak,height:0,curveSegments:5});M.computeBoundingBox();var D=M.boundingBox.max.x-M.boundingBox.min.x,C=M.boundingBox.max.y-M.boundingBox.min.y;M.center=true;ay=Math.max(ay,C);M.gry=ae;Y.push(M);if(!w.last_major()){var ax=(w.next_major_grpos()-ae);if(D>0){V=Math.min(V,0.9*ax/D)}if(this.y_handle.IsCenterLabels()){M.gry+=ax/2}}}ap.push(0,ae,0,(at?-al:-al*0.6),ae,0)}if(L&&L.fTitle){var M=new f.TextGeometry(L.fTitle,{font:a.threejs_font_helvetiker_regular,size:ak,height:0,curveSegments:5});M.computeBoundingBox();M.center=L.TestBit(a.EAxisBits.kCenterTitle);M.grx=2;M.gry=(P+o)/2;Y.push(M)}if(!Z.use_y_for_z){var aA=a.Painter.createLineSegments(ap,B),ac=new f.Object3D();ac.position.set(Q,0,N);ac.rotation.y=-1/4*Math.PI;ac.add(aA);Y.forEach(function(aC){var aB=aC.boundingBox.max.x-aC.boundingBox.min.x,aE=aC.center?aC.gry+aB/2:o,n=new f.Matrix4();n.set(0,V,0,(-ay*V-1.5*al)*(aC.grx||1),-V,0,0,aE,0,0,1,0,0,0,0,1);var aD=new f.Mesh(aC,G);aD.applyMatrix(n);ac.add(aD)});ac.xyid=3;if(Z.zoom){ac.add(ao("y",this.size_xy3d))}s.add(ac);ac=new f.Object3D();ac.position.set(p,0,N);ac.rotation.y=-3/4*Math.PI;ac.add(new f.LineSegments(aA.geometry,B));Y.forEach(function(aC){var aB=aC.boundingBox.max.x-aC.boundingBox.min.x,aE=aC.center?aC.gry-aB/2:o-aB,n=new f.Matrix4();n.set(0,V,0,(-ay*V-1.5*al)*(aC.grx||1),V,0,0,aE,0,0,-1,0,0,0,0,1);var aD=new f.Mesh(aC,G);aD.applyMatrix(n);ac.add(aD)});ac.xyid=1;if(Z.zoom){ac.add(ao("y",this.size_xy3d))}s.add(ac)}Y=[];V=1;ap=[];var X=null,W=null,az=null,q=H?H.fZaxis:null,U=0;if(this.size_z3d){X=[];W=[]}while(am.next()){var ad=am.grpos,at=(am.kind==1),O=this.z_handle.format(am.tick,true,true);if(O===null){at=false;O=""}if(at&&O&&(O.length>0)){var M=new f.TextGeometry(O,{font:a.threejs_font_helvetiker_regular,size:ak,height:0,curveSegments:5});M.computeBoundingBox();var D=M.boundingBox.max.x-M.boundingBox.min.x,C=M.boundingBox.max.y-M.boundingBox.min.y;M.translate(-D,-C/2,0);M.grz=ad;Y.push(M);if((az!==null)&&(C>0)){V=Math.min(V,0.9*(ad-az)/C)}U=Math.max(U,D);az=ad}if(X&&at){X.push(Q,0,ad,p,0,ad)}if(W&&at){W.push(0,P,ad,0,o,ad)}ap.push(0,0,ad,(at?al:al*0.6),0,ad)}if(X&&(X.length>0)){var av=new f.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var S=a.Painter.createLineSegments(X,av);S.position.set(0,o,0);S.grid=2;S.visible=false;s.add(S);var R=new f.LineSegments(S.geometry,av);R.position.set(0,P,0);R.grid=4;R.visible=false;s.add(R)}if(W&&(W.length>0)){var av=new f.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var S=a.Painter.createLineSegments(W,av);S.position.set(p,0,0);S.grid=3;S.visible=false;s.add(S);var R=new f.LineSegments(S.geometry,av);R.position.set(Q,0,0);R.grid=1;R.visible=false;s.add(R)}var E=[],u=a.Painter.createLineSegments(ap,B);for(var ar=0;ar<4;++ar){E.push(new f.Object3D());Y.forEach(function(aB){var n=new f.Matrix4();n.set(-V,0,0,2*al,0,0,1,0,0,V,0,aB.grz);var aC=new f.Mesh(aB,G);aC.applyMatrix(n);E[ar].add(aC)});if(q&&q.fTitle){var M=new f.TextGeometry(q.fTitle,{font:a.threejs_font_helvetiker_regular,size:ak,height:0,curveSegments:5});M.computeBoundingBox();var D=M.boundingBox.max.x-M.boundingBox.min.x,C=M.boundingBox.max.y-M.boundingBox.min.y,J=q.TestBit(a.EAxisBits.kCenterTitle)?(k+N-D)/2:k-D;M.rotateZ(Math.PI/2);var au=new f.Matrix4();au.set(-V,0,0,3*al+U,0,0,1,0,0,V,0,J);var T=new f.Mesh(M,G);T.applyMatrix(au);E[ar].add(T)}E[ar].add(ar==0?u:new f.LineSegments(u.geometry,B));if(Z.zoom){E[ar].add(ao("z",this.size_z3d,Z.use_y_for_z))}E[ar].zid=ar+2;s.add(E[ar])}E[0].position.set(Q,o,0);E[0].rotation.z=3/4*Math.PI;E[1].position.set(p,o,0);E[1].rotation.z=1/4*Math.PI;E[2].position.set(p,P,0);E[2].rotation.z=-1/4*Math.PI;E[3].position.set(Q,P,0);E[3].rotation.z=-3/4*Math.PI;if(this.size_z3d===0){return}var t=a.Painter.createLineSegments([Q,0,0,p,0,0],B,null,true);for(var ar=0;ar<2;++ar){var x=new f.LineSegments(t,B);x.position.set(0,P,(ar===0)?N:k);x.xyboxid=2;x.bottom=(ar==0);s.add(x);x=new f.LineSegments(t,B);x.position.set(0,o,(ar===0)?N:k);x.xyboxid=4;x.bottom=(ar==0);s.add(x)}var ai=a.Painter.createLineSegments([0,P,0,0,o,0],B,null,true);for(var ar=0;ar<2;++ar){var x=new f.LineSegments(ai,B);x.position.set(Q,0,(ar===0)?N:k);x.xyboxid=3;x.bottom=(ar==0);s.add(x);x=new f.LineSegments(ai,B);x.position.set(p,0,(ar===0)?N:k);x.xyboxid=1;x.bottom=(ar==0);s.add(x)}var v=a.Painter.createLineSegments([0,0,N,0,0,k],B,null,true);for(var ar=0;ar<4;++ar){var x=new f.LineSegments(v,B);x.zboxid=E[ar].zid;x.position.copy(E[ar].position);s.add(x)}};a.THistPainter.prototype.Draw3DBins=function(){if(!this.draw_content){return}if(this.IsTH2Poly()&&this.DrawPolyLego){return this.DrawPolyLego()}if((this.Dimension()==2)&&this.options.Contour&&this.DrawContour3D){return this.DrawContour3D(true)}if((this.Dimension()==2)&&this.options.Surf&&this.DrawSurf){return this.DrawSurf()}if((this.Dimension()==2)&&this.options.Error&&this.DrawError){return this.DrawError()}var ae=a.Painter.Box3D.Vertices,Q=a.Painter.Box3D.Indexes,aK=a.Painter.Box3D.Normals,aE=a.Painter.Box3D.Segments,J=[0,1,1,2,2,3,3,0],aM=[new f.Vector3(0,0,0),new f.Vector3(0,1,0),new f.Vector3(1,1,0),new f.Vector3(1,0,0)],A=this.main_painter(),aG=A.grz.domain()[0],z=A.grz.domain()[1],aj=A.PrepareColorDraw({rounding:false,use3d:true,extra:1}),an=aj.i1,am=aj.i2,ac=aj.j1,ab=aj.j2,T,S,F,E,s,r,at,ar,ai,ao,aC,m=this,t=this.GetObject(),Z=t?t.$baseh:null,ad=(this.options.Lego===11)||(this.options.Lego===13);if((an>=am)||(ac>=ab)){return}function ax(j,k,aN){ar=t.getBinContent(j+1,k+1);if(Z){at=Z.getBinContent(j+1,k+1)}else{if(m.options.BaseLine!==false){at=m.options.BaseLine}else{at=m.options.Zero?aG:0}}if(ar<at){var v=at;at=ar;ar=v}if((at>=O)||(ar<y)){return false}ai=(ar===y)||(at>=ar);if(!ai||(aN>0)){return true}if(t["$baseh"]){return false}if(m.options.Zero||(aG>0)){return true}return m._show_empty_bins}var N=(this.histo.getBin(am,ab)<65535),ah=[aG,z],U=null,ay=0;if((this.options.Lego===12)||(this.options.Lego===14)){ah=this.CreateContour(this.histo.fContour?this.histo.fContour.length:20,this.lego_zmin,this.lego_zmax);U=this.GetPalette()}for(var av=0;av<ah.length-1;++av){var y=ah[av],O=ah[av+1],aH=0,aF=0,aq=A.grz(y),aL=A.grz(O),l=0,C=0;for(T=an;T<am;++T){for(S=ac;S<ab;++S){if(!ax(T,S,av)){continue}ao=!ai&&(av>0);aC=!ai&&(ar>O)&&(av<ah.length-2);l+=(ai?12:Q.length);if(ao){l-=6}if(aC){l-=6}if(ad&&!ai){l-=12;C+=12}}}ay+=l+C;var u=new Float32Array(l*3),aD=new Float32Array(l*3),ak=N?new Uint16Array(l):new Uint32Array(l),X=null,al=null,B=null,L=0,ag=0,az,H,R,af;if(C>0){X=new Float32Array(C*3);al=new Float32Array(C*3);B=N?new Uint16Array(C):new Uint32Array(C)}for(T=an;T<am;++T){F=aj.grx[T];E=aj.grx[T+1];for(S=ac;S<ab;++S){if(!ax(T,S,av)){continue}ao=!ai&&(av>0);aC=!ai&&(ar>O)&&(av<ah.length-2);s=aj.gry[S];r=aj.gry[S+1];aH=(at<=y)?aq:A.grz(at);aF=(ar>O)?aL:A.grz(ar);af=0;R=0;if(ai){af+=12;R+=24}var M=Q.length,n=this.histo.getBin(T+1,S+1);if(ao){M-=6}while(R<M){az=ae[Q[R]];if(ad&&(R<12)){X[ag]=F+az.x*(E-F);X[ag+1]=s+az.y*(r-s);X[ag+2]=aH+az.z*(aF-aH);al[ag]=aK[af];al[ag+1]=aK[af+1];al[ag+2]=aK[af+2];B[ag/3]=n;ag+=3}else{u[L]=F+az.x*(E-F);u[L+1]=s+az.y*(r-s);u[L+2]=aH+az.z*(aF-aH);aD[L]=aK[af];aD[L+1]=aK[af+1];aD[L+2]=aK[af+2];ak[L/3]=n;L+=3}++R;if(R%6===0){af+=3;if(aC&&(R===Q.length-12)){R+=6;af+=3}}}}}var ap=new f.BufferGeometry();ap.addAttribute("position",new f.BufferAttribute(u,3));ap.addAttribute("normal",new f.BufferAttribute(aD,3));var au=t.fFillColor,x=this.get_color(au);if(U){x=U.calcColor(av,ah.length)}else{if((this.options.Lego===1)||(au<2)){au=1;x="white"}}var aJ=new f.MeshBasicMaterial({color:x,shading:f.SmoothShading});var W=new f.Mesh(ap,aJ);W.bins_index=ak;W.painter=this;W.zmin=aG;W.zmax=z;W.baseline=(this.options.BaseLine===false)?aG:this.options.BaseLine;W.tip_color=(au===3)?16711680:65280;W.tooltip=function(k){if((k.index<0)||(k.index>=this.bins_index.length)){return null}var aS=this.painter,j=aS.main_painter(),aR=aS.GetObject(),aQ=aS.Get3DToolTip(this.bins_index[k.index]);aQ.x1=Math.max(-j.size_xy3d,j.grx(aS.GetBinX(aQ.ix-1)));aQ.x2=Math.min(j.size_xy3d,j.grx(aS.GetBinX(aQ.ix)));if(aS.Dimension()===1){aQ.y1=j.gry(0);aQ.y2=j.gry(1)}else{aQ.y1=Math.max(-j.size_xy3d,j.gry(aS.GetBinY(aQ.iy-1)));aQ.y2=Math.min(j.size_xy3d,j.gry(aS.GetBinY(aQ.iy)))}var aP=this.baseline,aO=aQ.value;if(aR["$baseh"]){aP=aR["$baseh"].getBinContent(aQ.ix,aQ.iy)}if(aO<aP){var aN=aP;aP=aO;aO=aN}aQ.z1=j.grz(Math.max(this.zmin,aP));aQ.z2=j.grz(Math.min(this.zmax,aO));aQ.color=this.tip_color;return aQ};A.toplevel.add(W);if(C>0){var aw=new f.BufferGeometry();aw.addAttribute("position",new f.BufferAttribute(X,3));aw.addAttribute("normal",new f.BufferAttribute(al,3));var q=(au<2)?new f.Color(16711680):new f.Color(i.rgb(x).darker(0.5).toString());var aA=new f.MeshBasicMaterial({color:q,shading:f.SmoothShading});var I=new f.Mesh(aw,aA);I.bins_index=B;I.painter=this;I.tooltip=W.tooltip;I.zmin=W.zmin;I.zmax=W.zmax;I.baseline=W.baseline;I.tip_color=W.tip_color;A.toplevel.add(I)}}if(this.options.Lego>12){return}var aI=0,K=0,aa=true,G=0;O=z;y=aG;for(T=an;T<am;++T){for(S=ac;S<ab;++S){if(!ax(T,S,0)){G++;continue}aI+=(ai?aM.length:ae.length);K+=(ai?J.length:aE.length)}}if(aI>65520){aa=false}if(!aa){aI=K*3}var D=new Float32Array(aI*3),o=aa?new Uint16Array(K):null;var aH=0,aF=0,aq=A.grz(aG),aL=A.grz(z),aB=0,P=0;for(T=an;T<am;++T){F=aj.grx[T];E=aj.grx[T+1];for(S=ac;S<ab;++S){if(!ax(T,S,0)){continue}s=aj.gry[S];r=aj.gry[S+1];aH=(at<=aG)?aq:A.grz(at);aF=(ar>z)?aL:A.grz(ar);var V=ai?J:aE,Y=ai?aM:ae;if(aa){for(R=0;R<V.length;++R){o[P++]=aB/3+V[R]}for(R=0;R<Y.length;++R){az=Y[R];D[aB]=F+az.x*(E-F);D[aB+1]=s+az.y*(r-s);D[aB+2]=aH+az.z*(aF-aH);aB+=3}}else{for(R=0;R<V.length;++R){az=Y[V[R]];D[aB]=F+az.x*(E-F);D[aB+1]=s+az.y*(r-s);D[aB+2]=aH+az.z*(aF-aH);aB+=3}}}}var p=this.get_color(t.fLineColor);aJ=new f.LineBasicMaterial({color:new f.Color(p)});if(!a.browser.isIE){aJ.linewidth=t.fLineWidth}var w=a.Painter.createLineSegments(D,aJ,aa?o:null);A.toplevel.add(w)};a.Painter.drawAxis3D=function(m,l,k){var j=new a.TObjectPainter(l);if(!("_main" in l)){j.SetDivId(m)}j.Draw3DAxis=function(){var n=this.main_painter();if(!n&&("_main" in this.GetObject())){n=this.GetObject()._main}if(!n||!n._toplevel){return console.warn("no geo object found for 3D axis drawing")}var o=new f.Box3().setFromObject(n._toplevel);this.xmin=o.min.x;this.xmax=o.max.x;this.ymin=o.min.y;this.ymax=o.max.y;this.zmin=o.min.z;this.zmax=o.max.z;this.size_xy3d=this.size_z3d=0;this.DrawXYZ=a.THistPainter.prototype.DrawXYZ;this.DrawXYZ(n._toplevel);n.adjustCameraPosition();n.TestAxisVisibility=c;n.Render3D()};j.Draw3DAxis();return j.DrawingReady()};a.TH1Painter.prototype.Draw3D=function(l,k){this.mode3d=true;var j=this.main_painter();if(k){if((j===this)&&(this.Resize3D!==undefined)&&this.Resize3D()){this.Render3D()}}else{this.DeleteAtt();if(j===this){this.Create3DScene();this.DrawXYZ(this.toplevel,{use_y_for_z:true,zmult:1.1,zoom:a.gStyle.Zooming})}this.ScanContent(true);this.Draw3DBins();j.Render3D();this.UpdateStatWebCanvas();this.AddKeysHandler()}if(j===this){this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)));this.DrawTitle()}a.CallBack(l)};a.TH2Painter.prototype.Draw3D=function(m,l){this.mode3d=true;var j=this.main_painter();if(l){if((j===this)&&(this.Resize3D!==undefined)&&this.Resize3D()){this.Render3D()}}else{var n=this.root_pad();this.zmin=n.fLogz?this.gminposbin*0.3:this.gminbin;this.zmax=this.gmaxbin;var k=1.1;if(this.options.minimum!==-1111){this.zmin=this.options.minimum}if(this.options.maximum!==-1111){this.zmax=this.options.maximum;k=1}if(n.fLogz&&(this.zmin<=0)){this.zmin=this.zmax*0.00001}this.DeleteAtt();if(j===this){this.Create3DScene();this.DrawXYZ(this.toplevel,{zmult:k,zoom:a.gStyle.Zooming})}this.Draw3DBins();j.Render3D();this.UpdateStatWebCanvas();this.AddKeysHandler()}if(j===this){this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)||(this.options.Surf===11)||(this.options.Surf===12)));this.DrawTitle()}a.CallBack(m)};a.TH2Painter.prototype.DrawContour3D=function(p){var l=this.main_painter(),o=this.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0}),n=this.GetObject(),q=this.GetContour(),k=this.GetPalette(),j=2*l.size_z3d,m=[];this.BuildContour(o,q,k,function(s,x,y,u,t,w){if(t-u<3){return}if(p){j=l.grz(q[w]);if((j<0)||(j>2*l.size_z3d)){return}}for(var v=u;v<t;++v){m.push(x[v],y[v],j);m.push(x[v+1],y[v+1],j)}});var r=a.Painter.createLineSegments(m,a.Painter.Create3DLineMaterial(this,n));l.toplevel.add(r)};a.TH2Painter.prototype.DrawSurf=function(){var A=this.GetObject(),r=this.main_painter(),L=r.PrepareColorDraw({rounding:false,use3d:true,extra:1,middle:0.5}),ai,af,D,ao,C,am,J,H,p,l,I=r.grz.domain()[0],ae=r.grz.domain()[1];var N=!r.logz?r.grz:function(j){return j<I?-0.1:r.grz(j)};if((L.i2-L.i1<2)||(L.j2-L.j1<2)){return}var S=null,K=null,t=true,an=false,U=false,ah=null;switch(this.options.Surf){case 11:S=this.GetContour();ah=this.GetPalette();break;case 12:case 15:case 17:S=this.GetContour();ah=this.GetPalette();t=false;break;case 14:t=false;U=true;break;case 16:S=this.GetContour();an=true;t=false;break;default:S=r.z_handle.CreateTicks(true);an=true;break}if(S){K=new Float32Array(S.length);for(var Q=0;Q<S.length;++Q){K[Q]=N(S[Q])}}else{K=[0,2*r.size_z3d]}var q,o=[],P=[],O=[],s=0,ak=null,aj=0,m=0,X=null,z=0,G=null;function al(n,k,j){if(n<k){return -1}if(n>j){return 1}return 0}function w(ap,au,ar,n,at,aq){if(!t){return}var k=al(ar,0,2*r.size_z3d),j=al(aq,0,2*r.size_z3d);if((k===j)&&(k!==0)){return}if(!q){return ++s}if(k!==0){var av=aq-ar;ar=(k<0)?0:2*r.size_z3d;ap=n-(n-ap)/av*(aq-ar);au=at-(at-au)/av*(aq-ar)}if(j!==0){var av=ar-aq;aq=(j<0)?0:2*r.size_z3d;n=ap-(ap-n)/av*(ar-aq);at=au-(au-at)/av*(ar-aq)}ak[aj]=ap;ak[aj+1]=au;ak[aj+2]=ar;aj+=3;ak[aj]=n;ak[aj+1]=at;ak[aj+2]=aq;aj+=3}var V=new Float32Array(6*3),ad=0,R=0;var F=new Float32Array(2*3),aa=0;function E(ar,k,aw,aq,j,av,at,au){if(ad>=V.length){console.log("more than 6 points???")}var ap=(at-aw)/(av-aw),n=3;if((R!==0)&&(Math.abs(ap)<Math.abs(R))){V[ad]=V[ad-3];V[ad+1]=V[ad-2];V[ad+2]=V[ad-1];ad-=3;n=6}V[ad]=ar+ap*(aq-ar);V[ad+1]=k+ap*(j-k);V[ad+2]=at;if(au&&X){F[aa]=V[ad];F[aa+1]=V[ad+1];F[aa+2]=V[ad+2];aa+=3}ad+=n;R=ap}function ag(ap,k,n){var j=((k-L.i1)*(L.j2-L.j1)+(n-L.j1))*8;if(G[j]>=0){return console.error("More than 8 vertexes for the bin")}var aq=j+8+G[j];G[j]--;G[aq]=ap}function v(ar){for(var aw=L.i1;aw<L.i2;++aw){for(var au=L.j1;au<L.j2;++au){var ax=((aw-L.i1)*(L.j2-L.j1)+(au-L.j1))*8;if(G[ax]===-1){continue}var av=(G[ax]>=0)?ax:ax+9+G[ax],aq=ax+8,ap=0,n=0,k=0;for(var j=av;j<aq;++j){var at=G[j];if(at<0){return console.error("FAILURE in NORMALS RECALCULATIONS")}ap+=ar[at];n+=ar[at+1];k+=ar[at+2]}ap=ap/(aq-av);n=n/(aq-av);k=k/(aq-av);for(var j=av;j<aq;++j){var at=G[j];ar[at]=ap;ar[at+1]=n;ar[at+2]=k}}}}function W(aD,n,ay,aC,k,ax,aB,j,av,aG){for(var aA=1;aA<K.length;++aA){var ar=al(ay,K[aA-1],K[aA]),aq=al(ax,K[aA-1],K[aA]),ap=al(av,K[aA-1],K[aA]),aw=ar+aq+ap;if(aw===3){continue}if(aw===-3){return}if(!q){var au=Math.abs(aq-ar)+Math.abs(ap-aq)+Math.abs(ar-ap);if(ar===0){++au}if(aq===0){++au}if(ap===0){++au}if((au===1)||(au===2)){console.error("FOND npnts",au)}if(au>2){if(o[aA]===undefined){o[aA]=0}o[aA]+=au-2}if(((ar>0)||(aq>0)||(ap>0))&&((ar!==aq)||(aq!==ap)||(ap!==ar))){++m}continue}aa=0;ad=0;if(ar===0){V[ad]=aD;V[ad+1]=n;V[ad+2]=ay;ad+=3}if(ar!==aq){R=0;if((ar<0)||(aq<0)){E(aD,n,ay,aC,k,ax,K[aA-1])}if((ar>0)||(aq>0)){E(aD,n,ay,aC,k,ax,K[aA],true)}}if(aq===0){V[ad]=aC;V[ad+1]=k;V[ad+2]=ax;ad+=3}if(aq!==ap){R=0;if((aq<0)||(ap<0)){E(aC,k,ax,aB,j,av,K[aA-1])}if((aq>0)||(ap>0)){E(aC,k,ax,aB,j,av,K[aA],true)}}if(ap===0){V[ad]=aB;V[ad+1]=j;V[ad+2]=av;ad+=3}if(ap!==ar){R=0;if((ap<0)||(ar<0)){E(aB,j,av,aD,n,ay,K[aA-1])}if((ap>0)||(ar>0)){E(aB,j,av,aD,n,ay,K[aA],true)}}if(ad===0){continue}if(ad<9){console.log("found less than 3 points",ad/3);continue}if(X&&(aa===6)){for(var aE=0;aE<6;++aE){X[z+aE]=F[aE]}z+=6}var aF=P[aA],az=O[aA];if(U&&(ad===9)){ag(az,ai,af);ag(az+3,ai+1,aG?af+1:af);ag(az+6,aG?ai:ai+1,af+1)}for(var at=3;at<ad-3;at+=3){aF[az]=V[0];aF[az+1]=V[1];aF[az+2]=V[2];az+=3;aF[az]=V[at];aF[az+1]=V[at+1];aF[az+2]=V[at+2];az+=3;aF[az]=V[at+3];aF[az+1]=V[at+4];aF[az+2]=V[at+5];az+=3}O[aA]=az}}if(U){G=new Int32Array((L.i2-L.i1)*(L.j2-L.j1)*8);for(var Z=0;Z<G.length;++Z){G[Z]=-1}}for(q=0;q<2;++q){if(q){for(var ab=1;ab<K.length;++ab){if(o[ab]){P[ab]=new Float32Array(o[ab]*9);O[ab]=0}}if(t&&(s>0)){ak=new Float32Array(s*6)}if(an&&(m>0)){X=new Float32Array(m*6)}}for(ai=L.i1;ai<L.i2-1;++ai){D=L.grx[ai];C=L.grx[ai+1];for(af=L.j1;af<L.j2-1;++af){ao=L.gry[af];am=L.gry[af+1];J=N(A.getBinContent(ai+1,af+1));H=N(A.getBinContent(ai+1,af+2));p=N(A.getBinContent(ai+2,af+1));l=N(A.getBinContent(ai+2,af+2));W(D,ao,J,C,am,l,D,am,H,true);W(D,ao,J,C,ao,p,C,am,l,false);w(D,am,H,D,ao,J);w(D,ao,J,C,ao,p);if(ai===L.i2-2){w(C,ao,p,C,am,l)}if(af===L.j2-2){w(D,am,H,C,am,l)}}}}for(var ab=1;ab<K.length;++ab){if(P[ab]){if(O[ab]!==o[ab]*9){console.error("SURF faces missmatch lvl",ab,"faces",o[ab],"index",O[ab],"check",o[ab]*9-O[ab])}var B=new f.BufferGeometry();B.addAttribute("position",new f.BufferAttribute(P[ab],3));B.computeVertexNormals();if(U&&(ab===1)){v(B.getAttribute("normal").array)}var u,ac;if(ah){u=ah.calcColor(ab,K.length)}else{u=A.fFillColor>1?this.get_color(A.fFillColor):"white";if((this.options.Surf===14)&&(A.fFillColor<2)){u=this.get_color(48)}}if(this.options.Surf===14){ac=new f.MeshLambertMaterial({color:u,side:f.DoubleSide})}else{ac=new f.MeshBasicMaterial({color:u,side:f.DoubleSide})}var M=new f.Mesh(B,ac);r.toplevel.add(M);M.painter=this}}if(ak){if(s*6!==aj){console.error("SURF lines mismmatch nsegm",s," lindx",aj,"difference",s*6-aj)}var y=this.get_color(A.fLineColor),ac=new f.LineBasicMaterial({color:new f.Color(y)});if(!a.browser.isIE){ac.linewidth=A.fLineWidth}var x=a.Painter.createLineSegments(ak,ac);x.painter=this;r.toplevel.add(x)}if(X){if(m*6!==z){console.error("SURF grid draw mismatch ngridsegm",m,"gindx",z,"diff",m*6-z)}var ac;if(this.options.Surf===1){ac=new f.LineDashedMaterial({color:0,dashSize:2,gapSize:2})}else{ac=new f.LineBasicMaterial({color:new f.Color(this.get_color(A.fLineColor))})}var x=a.Painter.createLineSegments(X,ac);x.painter=this;r.toplevel.add(x)}if(this.options.Surf===17){this.DrawContour3D()}if(this.options.Surf===13){L=r.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0});var K=this.GetContour(),ah=this.GetPalette(),Y=-1,T=2*r.size_z3d;this.BuildContour(L,K,ah,function(au,aw,aD,aF,aA){if(aA-aF<3){return}var az=[];for(var aC=aF;aC<=aA;++aC){if((aC===aF)||(aw[aC]!==aw[aC-1])||(aD[aC]!==aD[aC-1])){az.push(new f.Vector2(aw[aC],aD[aC]))}}if(az.length<3){return}var k=f.ShapeUtils.triangulateShape(az,[]);if(!k||(k.length===0)){return}if((Y<0)||(Y!==au)){Y=au;T+=0.0001*r.size_z3d}var at=new Float32Array(k.length*9),ar=new Float32Array(k.length*9),aG=0;for(var aB=0;aB<k.length;++aB){var av=k[aB];for(var ax=0;ax<3;++ax){var aE=az[av[ax]];at[aG]=aE.x;at[aG+1]=aE.y;at[aG+2]=T;ar[aG]=0;ar[aG+1]=0;ar[aG+2]=1;aG+=3}}var aq=new f.BufferGeometry();aq.addAttribute("position",new f.BufferAttribute(at,3));aq.addAttribute("normal",new f.BufferAttribute(ar,3));var ap=ah.getColor(au);var ay=new f.MeshBasicMaterial({color:ap,shading:f.SmoothShading,side:f.DoubleSide,opacity:0.5});var j=new f.Mesh(aq,ay);j.painter=this;r.toplevel.add(j)})}};a.TH2Painter.prototype.DrawError=function(){var n=this,o=this.main_painter(),F=o.PrepareColorDraw({rounding:false,use3d:true,extra:1}),D=o.grz.domain()[0],H=o.grz.domain()[1],A,z,y,w,q,C,m,B,l,u,t,k=0,p=null,r=null,x=0;function G(){if(n.options.Zero||(D>0)){return false}return !n._show_empty_bins}for(var E=0;E<2;++E){for(A=F.i1;A<F.i2;++A){C=F.grx[A];B=F.grx[A+1];for(z=F.j1;z<F.j2;++z){w=this.histo.getBinContent(A+1,z+1);if((w<D)||(w>H)){continue}if((w===D)&&G()){continue}if(E===0){k+=3;continue}y=this.histo.getBin(A+1,z+1);q=this.histo.getBinError(y);r[x/18]=y;m=F.gry[z];l=F.gry[z+1];u=o.grz((w-q<D)?D:w-q);t=o.grz((w+q>H)?H:w+q);p[x]=C;p[x+3]=B;p[x+1]=p[x+4]=(m+l)/2;p[x+2]=p[x+5]=(u+t)/2;x+=6;p[x]=p[x+3]=(C+B)/2;p[x+1]=m;p[x+4]=l;p[x+2]=p[x+5]=(u+t)/2;x+=6;p[x]=p[x+3]=(C+B)/2;p[x+1]=p[x+4]=(m+l)/2;p[x+2]=u;p[x+5]=t;x+=6}}if(E===0){if(k===0){return}p=new Float32Array(k*6);r=new Int32Array(k/3)}}var I=this.get_color(this.GetObject().fLineColor),v=new f.LineBasicMaterial({color:new f.Color(I)}),s=a.Painter.createLineSegments(p,v);if(!a.browser.isIE){v.linewidth=this.GetObject().fLineWidth}s.painter=this;s.intersect_index=r;s.zmin=D;s.zmax=H;s.tip_color=(this.GetObject().fLineColor===3)?16711680:65280;s.tooltip=function(J){var M=Math.floor(J.index/6);if((M<0)||(M>=this.intersect_index.length)){return null}var L=this.painter,j=L.main_painter(),K=L.Get3DToolTip(this.intersect_index[M]);K.x1=Math.max(-j.size_xy3d,j.grx(L.GetBinX(K.ix-1)));K.x2=Math.min(j.size_xy3d,j.grx(L.GetBinX(K.ix)));K.y1=Math.max(-j.size_xy3d,j.gry(L.GetBinY(K.iy-1)));K.y2=Math.min(j.size_xy3d,j.gry(L.GetBinY(K.iy)));K.z1=j.grz(K.value-K.error<this.zmin?this.zmin:K.value-K.error);K.z2=j.grz(K.value+K.error>this.zmax?this.zmax:K.value+K.error);K.color=this.tip_color;return K};o.toplevel.add(s)};a.TH2Painter.prototype.DrawPolyLego=function(){var B=this.GetObject(),J=this.main_painter(),F=this.grz.domain()[0],aa=this.grz.domain()[1],L,t,ab,G=B.fBins.arr.length,H=0,m=0,P=this.grz(F),O=P;this.fContour=null;this.fCustomContour=false;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(ab=0;ab<G;++ab){t=B.fBins.arr[ab];if(t.fContent<F){continue}L=this.getContourColor(t.fContent,true);if(L===null){continue}if((t.fXmin>J.scale_xmax)||(t.fXmax<J.scale_xmin)||(t.fYmin>J.scale_ymax)||(t.fYmax<J.scale_ymin)){continue}O=this.grz(t.fContent>aa?aa:t.fContent);var S=[],E=[],ac=1,s=t.fPoly,k=0;if(s._typename=="TMultiGraph"){ac=t.fPoly.fGraphs.arr.length;s=null}for(var K=0;K<ac;++K){if(!s||(K>0)){s=t.fPoly.fGraphs.arr[K]}var o=s.fNpoints,R=s.fX,Q=s.fY;while((o>2)&&(R[0]===R[o-1])&&(Q[0]===Q[o-1])){--o}var q,A;for(var u=0;u<2;++u){var U,T,z,v,l=J.size_xy3d*J.size_z3d,j=(u>0)?0:l/1000000;q=[];A=null;for(var D=0;D<o;++D){z=J.grx(R[D]);v=J.gry(Q[D]);if(D>0){l=(z-U)*(z-U)+(v-T)*(v-T)}if(l>j){q.push(new f.Vector2(z,v));U=z;T=v}}try{if(q.length>2){A=f.ShapeUtils.triangulateShape(q,[])}}catch(ad){A=null}if(A&&(A.length>q.length-3)){break}}if(A&&A.length&&q){S.push(q);E.push(A);k+=A.length*2;if(O>P){k+=q.length*2}}}var N=new Float32Array(k*9),M=0;for(var K=0;K<S.length;++K){var q=S[K],A=E[K];for(var p=0;p<2;++p){for(var V=0;V<A.length;++V){var w=A[V],Z=q[w[0]],Y=q[w[(p===0)?2:1]],W=q[w[(p===0)?1:2]];N[M]=Z.x;N[M+1]=Z.y;N[M+2]=p?O:P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=p?O:P;M+=3;N[M]=W.x;N[M+1]=W.y;N[M+2]=p?O:P;M+=3}}if(O>P){for(var V=0;V<q.length;++V){var Z=q[V],Y=q[(V>0)?V-1:q.length-1];N[M]=Z.x;N[M+1]=Z.y;N[M+2]=P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=O;M+=3;N[M]=Z.x;N[M+1]=Z.y;N[M+2]=P;M+=3;N[M]=Y.x;N[M+1]=Y.y;N[M+2]=O;M+=3;N[M]=Z.x;N[M+1]=Z.y;N[M+2]=O;M+=3}}}var C=new f.BufferGeometry();C.addAttribute("position",new f.BufferAttribute(N,3));C.computeVertexNormals();var r=this.fPalette.getColor(L);var X=new f.MeshBasicMaterial({color:r,shading:f.SmoothShading});var I=new f.Mesh(C,X);J.toplevel.add(I);I.painter=this;I.bins_index=ab;I.draw_z0=P;I.draw_z1=O;I.tip_color=65280;I.tooltip=function(y){var af=this.painter,n=af.main_painter(),x=af.GetObject().fBins.arr[this.bins_index];var ae={use_itself:true,x1:n.grx(x.fXmin),x2:n.grx(x.fXmax),y1:n.gry(x.fYmin),y2:n.gry(x.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:x.fContent,color:this.tip_color,info:af.ProvidePolyBinHints(this.bins_index)};return ae};m+=k;H++}};function h(j){a.THistPainter.call(this,j);this.mode3d=true}h.prototype=Object.create(a.THistPainter.prototype);h.prototype.ScanContent=function(p){if(p&&this.nbinsx&&this.nbinsy&&this.nbinsz){return}var m=this.GetObject();this.nbinsx=m.fXaxis.fNbins;this.nbinsy=m.fYaxis.fNbins;this.nbinsz=m.fZaxis.fNbins;this.xmin=m.fXaxis.fXmin;this.xmax=m.fXaxis.fXmax;this.ymin=m.fYaxis.fXmin;this.ymax=m.fYaxis.fXmax;this.zmin=m.fZaxis.fXmin;this.zmax=m.fZaxis.fXmax;this.gminbin=this.gmaxbin=m.getBinContent(1,1,1);for(var o=0;o<this.nbinsx;++o){for(var n=0;n<this.nbinsy;++n){for(var l=0;l<this.nbinsz;++l){var q=m.getBinContent(o+1,n+1,l+1);if(q<this.gminbin){this.gminbin=q}else{if(q>this.gmaxbin){this.gmaxbin=q}}}}}this.draw_content=this.gmaxbin>0;this.CreateAxisFuncs(true,true)};h.prototype.CountStat=function(){var x=this.GetObject(),p=0,w=0,D=0,m=0,t=0,B=0,l=0,C=this.GetSelectIndex("x","left"),A=this.GetSelectIndex("x","right"),k=this.GetSelectIndex("y","left"),j=this.GetSelectIndex("y","right"),v=this.GetSelectIndex("z","left"),s=this.GetSelectIndex("z","right"),H={entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},z,G,r,q,o,y,E,F,u,n;for(z=0;z<this.nbinsx+2;++z){q=this.GetBinX(z-0.5);o=(z<C)?0:(z>A?2:1);for(G=0;G<this.nbinsy+2;++G){y=this.GetBinY(G-0.5);E=(G<k)?0:(G>j?2:1);for(r=0;r<this.nbinsz+2;++r){F=this.GetBinZ(r-0.5);u=(r<v)?0:(r>s?2:1);n=x.getBinContent(z,G,r);H.entries+=n;if((o==1)&&(E==1)&&(u==1)){p+=n;w+=q*n;D+=y*n;m+=F*n;t+=q*q*n;B+=y*y*n;l+=F*F*n}}}}if((x.fTsumw>0)&&!this.IsAxisZoomed("x")&&!this.IsAxisZoomed("y")&&!this.IsAxisZoomed("z")){p=x.fTsumw;w=x.fTsumwx;t=x.fTsumwx2;D=x.fTsumwy;B=x.fTsumwy2;m=x.fTsumwz;l=x.fTsumwz2}if(p>0){H.meanx=w/p;H.meany=D/p;H.meanz=m/p;H.rmsx=Math.sqrt(Math.abs(t/p-H.meanx*H.meanx));H.rmsy=Math.sqrt(Math.abs(B/p-H.meany*H.meany));H.rmsz=Math.sqrt(Math.abs(l/p-H.meanz*H.meanz))}H.integral=p;if(x.fEntries>1){H.entries=x.fEntries}return H};h.prototype.FillStatistic=function(n,o,t){if(this.IgnoreStatsFill()){return false}var m=this.CountStat(),q=o%10,r=Math.floor(o/10)%10,p=Math.floor(o/100)%10,s=Math.floor(o/1000)%10,j=Math.floor(o/10000)%10,k=Math.floor(o/100000)%10,l=Math.floor(o/1000000)%10;n.ClearPave();if(q>0){n.AddText(this.GetObject().fName)}if(r>0){n.AddText("Entries = "+n.Format(m.entries,"entries"))}if(p>0){n.AddText("Mean x = "+n.Format(m.meanx));n.AddText("Mean y = "+n.Format(m.meany));n.AddText("Mean z = "+n.Format(m.meanz))}if(s>0){n.AddText("Std Dev x = "+n.Format(m.rmsx));n.AddText("Std Dev y = "+n.Format(m.rmsy));n.AddText("Std Dev z = "+n.Format(m.rmsz))}if(l>0){n.AddText("Integral = "+n.Format(m.integral,"entries"))}if(t){n.FillFunctionStat(this.FindFunction("TF1"),t)}return true};h.prototype.GetBinTips=function(m,j,o){var l=[],k=this.main_painter();l.push(this.GetTipName());if(k.x_kind=="labels"){l.push("x = "+k.AxisAsText("x",this.GetBinX(m))+"  xbin="+(m+1))}else{l.push("x = ["+k.AxisAsText("x",this.GetBinX(m))+", "+k.AxisAsText("x",this.GetBinX(m+1))+")   xbin="+(m+1))}if(k.y_kind=="labels"){l.push("y = "+k.AxisAsText("y",this.GetBinY(j))+"  ybin="+(j+1))}else{l.push("y = ["+k.AxisAsText("y",this.GetBinY(j))+", "+k.AxisAsText("y",this.GetBinY(j+1))+")  ybin="+(j+1))}if(k.z_kind=="labels"){l.push("z = "+k.AxisAsText("z",this.GetBinZ(o))+"  zbin="+(o+1))}else{l.push("z = ["+k.AxisAsText("z",this.GetBinZ(o))+", "+k.AxisAsText("z",this.GetBinZ(o+1))+")  zbin="+(o+1))}var n=this.GetObject().getBinContent(m+1,j+1,o+1);if(n===Math.round(n)){l.push("entries = "+n)}else{l.push("entries = "+a.FFormat(n,a.gStyle.fStatFormat))}return l};h.prototype.Draw3DScatter=function(){var w=this.GetObject(),p=this.main_painter(),C=this.GetSelectIndex("x","left",0.5),B=this.GetSelectIndex("x","right",0),o=this.GetSelectIndex("y","left",0.5),l=this.GetSelectIndex("y","right",0),t=this.GetSelectIndex("z","left",0.5),s=this.GetSelectIndex("z","right",0),K=this.GetTipName("<br/>"),F,E,D,H;if((B<=C)||(l<=o)||(s<=t)){return true}var r=(this.gmaxbin>1000)?1000/this.gmaxbin:1,G=0,I=Math.max(0,this.gminbin);for(F=C;F<B;++F){for(E=o;E<l;++E){for(D=t;D<s;++D){H=w.getBinContent(F+1,E+1,D+1);if(H<=I){continue}G+=Math.round(H*r)}}}if(G>(p.webgl?100000:30000)){return false}var y=new a.Painter.PointsCreator(G,p.webgl,p.size_xy3d/200),A=new Int32Array(G),J=0;for(F=C;F<B;++F){for(E=o;E<l;++E){for(D=t;D<s;++D){H=w.getBinContent(F+1,E+1,D+1);if(H<=I){continue}var q=Math.round(H*r);for(var z=0;z<q;++z){var x=this.GetBinX(F+Math.random()),v=this.GetBinY(E+Math.random()),u=this.GetBinZ(D+Math.random());A[J++]=w.getBin(F+1,E+1,D+1);y.AddPoint(p.grx(x),p.gry(v),p.grz(u))}}}}var m=y.CreatePoints(this.get_color(w.fMarkerColor));p.toplevel.add(m);m.bins=A;m.painter=this;m.tip_color=(w.fMarkerColor===3)?16711680:65280;m.tooltip=function(j){var k=Math.floor(j.index/this.nvertex);if((k<0)||(k>=this.bins.length)){return null}var L=this.painter,n=L.Get3DToolTip(this.bins[k]);n.x1=L.grx(L.GetBinX(n.ix-1));n.x2=L.grx(L.GetBinX(n.ix));n.y1=L.gry(L.GetBinY(n.iy-1));n.y2=L.gry(L.GetBinY(n.iy));n.z1=L.grz(L.GetBinZ(n.iz-1));n.z2=L.grz(L.GetBinZ(n.iz));n.color=this.tip_color;n.opacity=0.3;return n};return true};h.prototype.Draw3DBins=function(){if(!this.draw_content){return}if(!this.options.Box&&!this.options.GLBox&&!this.options.GLColor&&!this.options.Lego){if(this.Draw3DScatter()){return}}var aC=this.GetObject().fFillColor,y=this.get_color(aC),p=this.main_painter(),ao=0,l=false,ag=false,z=false,M=1,aj=true,N,aD,aF=this.options.Box,am=0.5;if(!aF&&this.options.Lego){aF=(this.options.Lego===1)?10:this.options.Lego}if((this.options.GLBox===11)||(this.options.GLBox===12)){am=0.4;l=true;if(this.options.GLBox===12){z=true}var x=a.Painter.TestWebGL()?new f.SphereGeometry(0.5,16,12):new f.SphereGeometry(0.5,8,6);x.applyMatrix(new f.Matrix4().makeRotationX(Math.PI/2));ao=x.faces.length*9;N=new Float32Array(ao);aD=new Float32Array(ao);for(var B=0;B<x.faces.length;++B){N[9*B]=x.vertices[x.faces[B].a].x;N[9*B+1]=x.vertices[x.faces[B].a].y;N[9*B+2]=x.vertices[x.faces[B].a].z;N[9*B+3]=x.vertices[x.faces[B].b].x;N[9*B+4]=x.vertices[x.faces[B].b].y;N[9*B+5]=x.vertices[x.faces[B].b].z;N[9*B+6]=x.vertices[x.faces[B].c].x;N[9*B+7]=x.vertices[x.faces[B].c].y;N[9*B+8]=x.vertices[x.faces[B].c].z;aD[9*B]=x.faces[B].vertexNormals[0].x;aD[9*B+1]=x.faces[B].vertexNormals[0].y;aD[9*B+2]=x.faces[B].vertexNormals[0].z;aD[9*B+3]=x.faces[B].vertexNormals[1].x;aD[9*B+4]=x.faces[B].vertexNormals[1].y;aD[9*B+5]=x.faces[B].vertexNormals[1].z;aD[9*B+6]=x.faces[B].vertexNormals[2].x;aD[9*B+7]=x.faces[B].vertexNormals[2].y;aD[9*B+8]=x.faces[B].vertexNormals[2].z}}else{var ai=a.Painter.Box3D.Indexes,Q=a.Painter.Box3D.Normals,m=a.Painter.Box3D.Vertices;ao=ai.length*3;N=new Float32Array(ao);aD=new Float32Array(ao);for(var au=0,aE=-3;au<ai.length;++au){var H=m[ai[au]];N[au*3]=H.x-0.5;N[au*3+1]=H.y-0.5;N[au*3+2]=H.z-0.5;if(au%6===0){aE+=3}aD[au*3]=Q[aE];aD[au*3+1]=Q[aE+1];aD[au*3+2]=Q[aE+2]}ag=true;if(aF===12){z=true}else{if(aF===13){z=true;ag=false}else{if(this.options.GLColor){z=true;M=0.5;aj=false;ag=false;l=true}}}}if(aj){aj=(this.gminbin||this.gmaxbin)?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1}var G=this.GetObject(),w=this.GetSelectIndex("x","left",0.5),v=this.GetSelectIndex("x","right",0),az=this.GetSelectIndex("y","left",0.5),aw=this.GetSelectIndex("y","right",0),X=this.GetSelectIndex("z","left",0.5),W=this.GetSelectIndex("z","right",0),D=this.GetTipName("<br/>");if((v<=w)||(aw<=az)||(W<=X)){return}var L=(this.grx(this.GetBinX(v))-this.grx(this.GetBinX(w)))/(v-w),K=(this.gry(this.GetBinY(aw))-this.gry(this.GetBinY(az)))/(aw-az),I=(this.grz(this.GetBinZ(W))-this.grz(this.GetBinZ(X)))/(W-X);var at=0,ay,av,au,s,q,af=[],A=0,ac=[];for(ay=w;ay<v;++ay){for(av=az;av<aw;++av){for(au=X;au<W;++au){q=G.getBinContent(ay+1,av+1,au+1);if((q===0)||(q<this.gminbin)){continue}s=aj?Math.pow(Math.abs(q*aj),0.3333):1;if(s<0.001){continue}at++;if(!z){continue}var S=this.getContourColor(q,true);if(S!=null){if(af[S]===undefined){af[S]=0;ac[S]=A++}af[S]+=1}else{console.error("not found color for",q)}}}}if(!z){af.push(at);A=1;ac=[0]}var T=new Array(A),t=new Array(A),al=new Array(A),ak=new Array(A),o=new Array(A),an=new Array(A),u=new Array(A);for(var J=0;J<af.length;++J){if(!af[J]){continue}at=af[J];var ah=ac[J];T[ah]=0;o[ah]=0;if(ag){o[ah]=(at*ao/3>65520)?2:1}t[ah]=new Float32Array(at*ao);al[ah]=new Float32Array(at*ao);ak[ah]=new Int32Array(at);if(o[ah]===1){an[ah]=new Uint16Array(at*a.Painter.Box3D.MeshSegments.length)}if(o[ah]===2){u[ah]=new Float32Array(at*a.Painter.Box3D.Segments.length*3)}}var aB,ab,aA,aa,ax,Z;for(ay=w;ay<v;++ay){aB=this.GetBinX(ay+0.5);ab=this.grx(aB);for(av=az;av<aw;++av){aA=this.GetBinY(av+0.5);aa=this.gry(aA);for(au=X;au<W;++au){q=G.getBinContent(ay+1,av+1,au+1);if((q===0)||(q<this.gminbin)){continue}s=aj?Math.pow(Math.abs(q*aj),0.3333):1;if(s<0.001){continue}var ah=0;if(z){var S=this.getContourColor(q,true);if(S===null){continue}ah=ac[S]}at=T[ah];ax=this.GetBinZ(au+0.5);Z=this.grz(ax);ak[ah][at]=G.getBin(ay+1,av+1,au+1);var Y=at*ao,F=t[ah],P=al[ah];for(var O=0;O<ao;O+=3,Y+=3){F[Y]=ab+N[O]*L*s;F[Y+1]=aa+N[O+1]*K*s;F[Y+2]=Z+N[O+2]*I*s;P[Y]=aD[O];P[Y+1]=aD[O+1];P[Y+2]=aD[O+2]}if(o[ah]===1){var ap=a.Painter.Box3D.MeshSegments;Y=at*ap.length;var V=Math.round(at*ao/3),ad=an[ah];for(var aq=0;aq<ap.length;++aq){ad[Y+aq]=V+ap[aq]}}if(o[ah]===2){var ap=a.Painter.Box3D.Segments,U=u[ah];Y=at*ap.length*3;for(var aq=0;aq<ap.length;++aq,Y+=3){var H=a.Painter.Box3D.Vertices[ap[aq]];U[Y]=ab+(H.x-0.5)*L*s;U[Y+1]=aa+(H.y-0.5)*K*s;U[Y+2]=Z+(H.z-0.5)*I*s}}T[ah]=at+1}}}for(var J=0;J<af.length;++J){if(!af[J]){continue}at=af[J];var ah=ac[J];var r=new f.BufferGeometry();r.addAttribute("position",new f.BufferAttribute(t[ah],3));r.addAttribute("normal",new f.BufferAttribute(al[ah],3));if(z){y=this.fPalette.getColor(J)}var ar=l?new f.MeshLambertMaterial({color:y,opacity:M,transparent:(M<1)}):new f.MeshBasicMaterial({color:y,opacity:M});var E=new f.Mesh(r,ar);E.bins=ak[ah];E.bins_faces=ao/3;E.painter=this;E.scalex=am*L;E.scaley=am*K;E.scalez=am*I;E.tip_color=(aC===3)?16711680:65280;E.use_scale=aj;E.tooltip=function(j){var aI=Math.floor(j.index/this.bins_faces);if((aI<0)||(aI>=this.bins.length)){return null}var aK=this.painter,aJ=aK.Get3DToolTip(this.bins[aI]),aG=aK.grx(aK.GetBinX(aJ.ix-0.5)),n=aK.gry(aK.GetBinY(aJ.iy-0.5)),k=aK.grz(aK.GetBinZ(aJ.iz-0.5)),aH=this.use_scale?Math.pow(Math.abs(aJ.value*this.use_scale),0.3333):1;aJ.x1=aG-this.scalex*aH;aJ.x2=aG+this.scalex*aH;aJ.y1=n-this.scaley*aH;aJ.y2=n+this.scaley*aH;aJ.z1=k-this.scalez*aH;aJ.z2=k+this.scalez*aH;aJ.color=this.tip_color;return aJ};p.toplevel.add(E);if(o[ah]>0){var C=this.get_color(this.GetObject().fLineColor),R=new f.LineBasicMaterial({color:C}),ae=null;if(o[ah]===1){ae=a.Painter.createLineSegments(t[ah],R,an[ah])}else{ae=a.Painter.createLineSegments(u[ah],R)}p.toplevel.add(ae)}}};h.prototype.Redraw=function(j){if(j){if(this.Resize3D()){this.Render3D()}}else{this.Create3DScene();this.DrawXYZ(this.toplevel,{zoom:a.gStyle.Zooming});this.Draw3DBins();this.Render3D();this.UpdateStatWebCanvas();this.AddKeysHandler()}this.DrawTitle()};h.prototype.FillToolbar=function(){var j=this.pad_painter(true);if(j===null){return}j.AddButton(a.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *");if(this.draw_content){j.AddButton(a.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox")}};h.prototype.CanZoomIn=function(l,k,j){if((l=="x")&&(this.GetIndexX(j,0.5)-this.GetIndexX(k,0)>1)){return true}if((l=="y")&&(this.GetIndexY(j,0.5)-this.GetIndexY(k,0)>1)){return true}if((l=="z")&&(this.GetIndexZ(j,0.5)-this.GetIndexZ(k,0)>1)){return true}return false};h.prototype.AutoZoom=function(){var x=this.GetSelectIndex("x","left"),v=this.GetSelectIndex("x","right"),m=this.GetSelectIndex("y","left"),l=this.GetSelectIndex("y","right"),p=this.GetSelectIndex("z","left"),o=this.GetSelectIndex("z","right"),C,A,z,r=this.GetObject();if((x===v)||(m===l)||(p===o)){return}var w=r.getBinContent(x+1,m+1,p+1);for(C=x;C<v;++C){for(A=m;A<l;++A){for(z=p;z<o;++z){w=Math.min(w,r.getBinContent(C+1,A+1,z+1))}}}if(w>0){return}var I=v,B=x,t=l,F=m,n=o,H=p;for(C=x;C<v;++C){for(A=m;A<l;++A){for(z=p;z<o;++z){if(r.getBinContent(C+1,A+1,z+1)>w){if(C<I){I=C}if(C>=B){B=C+1}if(A<t){t=A}if(A>=F){F=A+1}if(z<n){n=z}if(z>=H){H=z+1}}}}}var s,u,y,D,E,G,q=false;if((I===B-1)&&(I>x+1)&&(B<v-1)){I--;B++}if((t===F-1)&&(t>m+1)&&(F<l-1)){t--;F++}if((n===H-1)&&(n>p+1)&&(H<o-1)){n--;H++}if((I>x||B<v)&&(I<B-1)){s=this.GetBinX(I);u=this.GetBinX(B);q=true}if((t>m||F<l)&&(t<F-1)){y=this.GetBinY(t);D=this.GetBinY(F);q=true}if((n>p||H<o)&&(n<H-1)){E=this.GetBinZ(n);G=this.GetBinZ(H);q=true}if(q){this.Zoom(s,u,y,D,E,G)}};h.prototype.FillHistContextMenu=function(k){var j=a.getDrawSettings("ROOT."+this.GetObject()._typename,"nosame");k.addDrawMenu("Draw with",j.opts,function(l){if(l==="inspect"){return a.draw(this.divid,this.GetObject(),l)}this.options=this.DecodeOptions(l);this.Redraw()})};a.Painter.drawHistogram3D=function(n,k,m){var j=new a.TH3Painter(k);j.SetDivId(n,4);j.options=j.DecodeOptions(m);j.CheckPadRange();j.ScanContent();j.Redraw();var l=j.CreateStat();if(l){a.draw(j.divid,l,"")}j.FillToolbar();return j.DrawingReady()};function e(j){a.TObjectPainter.call(this,j)}e.prototype=Object.create(a.TObjectPainter.prototype);e.prototype.DecodeOptions=function(k){var l=new a.DrawOptions(k);var j={Color:l.check("COL"),Error:l.check("ERR")&&this.MatchObjectType("TGraph2DErrors"),Circles:l.check("P0"),Markers:l.check("P")};if(!j.Markers&&!j.Error&&!j.Circles){j.Markers=true}if(!j.Markers){j.Color=false}return j};e.prototype.CreateHistogram=function(){var D=this.GetObject();var A=D.fX[0],C=A,E=D.fY[0],G=E,I=D.fZ[0],K=I;for(var B=0;B<D.fNpoints;++B){var t=D.fX[B],r=D.fY[B],q=D.fZ[B],o=this.options.Error?D.fEX[B]:0,n=this.options.Error?D.fEY[B]:0,m=this.options.Error?D.fEZ[B]:0;A=Math.min(A,t-o);C=Math.max(C,t+o);E=Math.min(E,r-n);G=Math.max(G,r+n);I=Math.min(I,q-m);K=Math.max(K,q+m)}if(A>=C){C=A+1}if(E>=G){G=E+1}if(I>=K){K=I+1}var v=(C-A)*0.02,u=(G-E)*0.02,s=(K-I)*0.02,F=A-v,H=C+v,J=E-u,L=G+u,j=I-s,l=K+s;if((F<0)&&(A>=0)){F=A*0.98}if((H>0)&&(C<=0)){H=0}if((J<0)&&(E>=0)){J=E*0.98}if((L>0)&&(G<=0)){L=0}if((j<0)&&(I>=0)){j=I*0.98}if((l>0)&&(K<=0)){l=0}var k=this.GetObject();if(k.fMinimum!=-1111){j=k.fMinimum}if(k.fMaximum!=-1111){l=k.fMaximum}var w=a.CreateHistogram("TH2I",10,10);w.fName=k.fName+"_h";w.fTitle=k.fTitle;w.fXaxis.fXmin=F;w.fXaxis.fXmax=H;w.fYaxis.fXmin=J;w.fYaxis.fXmax=L;w.fZaxis.fXmin=j;w.fZaxis.fXmax=l;w.fMinimum=j;w.fMaximum=l;w.fBits=w.fBits|a.TH1StatusBits.kNoStats;return w};e.prototype.Graph2DTooltip=function(j){var n=Math.floor(j.index/this.nvertex);if((n<0)||(n>=this.index.length)){return null}n=this.index[n];var o=this.painter,m=o.grx(this.graph.fX[n]),l=o.gry(this.graph.fY[n]),k=o.grz(this.graph.fZ[n]);return{x1:m-this.scale0,x2:m+this.scale0,y1:l-this.scale0,y2:l+this.scale0,z1:k-this.scale0,z2:k+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+n,"x: "+o.x_handle.format(this.graph.fX[n]),"y: "+o.y_handle.format(this.graph.fY[n]),"z: "+o.z_handle.format(this.graph.fZ[n])]}};e.prototype.Redraw=function(){var p=this.main_painter(),l=this.GetObject(),q=1;if(!l||!p||!("renderer" in p)){return}function J(x,P){var z=0;for(var y=0;y<l.fNpoints;++y){if((l.fX[y]<p.scale_xmin)||(l.fX[y]>p.scale_xmax)||(l.fY[y]<p.scale_ymin)||(l.fY[y]>p.scale_ymax)||(l.fZ[y]<x)||(l.fZ[y]>=P)){continue}++z}return z}if((a.gStyle.OptimizeDraw>0)&&!p.webgl){var B=J(p.scale_zmin,p.scale_zmax),C=50000;if(B>C){q=Math.floor(B/C);if(q<=2){q=2}}}var F=new a.TAttMarkerHandler(l),K=null,r=[p.scale_zmin,p.scale_zmax],O=p.size_xy3d/100*F.GetFullSize();if(this.options.Circles){O=0.06*p.size_xy3d}if(p.usesvg){O*=0.3}if(this.options.Color){r=p.GetContour();K=p.GetPalette()}for(var G=0;G<r.length-1;++G){var k=Math.max(r[G],p.scale_zmin),m=Math.min(r[G+1],p.scale_zmax);if(k>=m){continue}var E=Math.floor(J(k,m)/q),D=null,H=0,s=new Int32Array(E),t=0,o=null,M=0;if(this.options.Markers||this.options.Circles){D=new a.Painter.PointsCreator(E,p.webgl,O/3)}if(this.options.Error){o=new Float32Array(E*6*3)}for(var I=0;I<l.fNpoints;++I){if((l.fX[I]<p.scale_xmin)||(l.fX[I]>p.scale_xmax)||(l.fY[I]<p.scale_ymin)||(l.fY[I]>p.scale_ymax)||(l.fZ[I]<k)||(l.fZ[I]>=m)){continue}if(q>1){H=(H+1)%q;if(H!==0){continue}}s[t++]=I;var w=p.grx(l.fX[I]),v=p.gry(l.fY[I]),u=p.grz(l.fZ[I]);if(D){D.AddPoint(w,v,u)}if(o){o[M]=p.grx(l.fX[I]-l.fEX[I]);o[M+1]=v;o[M+2]=u;o[M+3]=p.grx(l.fX[I]+l.fEX[I]);o[M+4]=v;o[M+5]=u;M+=6;o[M]=w;o[M+1]=p.gry(l.fY[I]-l.fEY[I]);o[M+2]=u;o[M+3]=w;o[M+4]=p.gry(l.fY[I]+l.fEY[I]);o[M+5]=u;M+=6;o[M]=w;o[M+1]=v;o[M+2]=p.grz(l.fZ[I]-l.fEZ[I]);o[M+3]=w;o[M+4]=v;o[M+5]=p.grz(l.fZ[I]+l.fEZ[I]);M+=6}}if(o){var N=this.get_color(this.GetObject().fLineColor),A=new f.LineBasicMaterial({color:new f.Color(N)});if(!a.browser.isIE){A.linewidth=this.GetObject().fLineWidth}var L=a.Painter.createLineSegments(o,A);p.toplevel.add(L);L.graph=l;L.index=s;L.painter=p;L.scale0=0.7*O;L.tip_name=this.GetTipName();L.tip_color=(l.fMarkerColor===3)?16711680:65280;L.nvertex=6;L.tooltip=this.Graph2DTooltip}if(D){var n="blue";if(!this.options.Circles){n=K?K.calcColor(G,r.length):this.get_color(l.fMarkerColor)}var j=D.CreatePoints(n);p.toplevel.add(j);j.graph=l;j.index=s;j.painter=p;j.scale0=0.3*O;j.tip_name=this.GetTipName();j.tip_color=(l.fMarkerColor===3)?16711680:65280;j.tooltip=this.Graph2DTooltip}}p.Render3D(100)};a.Painter.drawGraph2D=function(m,k,l){var j=new a.TGraph2DPainter(k);j.SetDivId(m,-1);j.options=j.DecodeOptions(l);if(j.main_painter()){j.SetDivId(m);j.Redraw();return j.DrawingReady()}if(!k.fHistogram){k.fHistogram=j.CreateHistogram()}a.draw(m,k.fHistogram,"lego;axis",function(n){j.ownhisto=true;j.SetDivId(m);j.Redraw();return j.DrawingReady()});return j};a.Painter.drawPolyMarker3D=function(m,l,k){var j=new a.TObjectPainter(l);j.SetDivId(m);j.Redraw=function(){var o=this.main_painter();if(!o||!("renderer" in o)){return}var n=1,s=50000,q=0;for(var r=0;r<l.fP.length;r+=3){if((l.fP[r]<o.scale_xmin)||(l.fP[r]>o.scale_xmax)||(l.fP[r+1]<o.scale_ymin)||(l.fP[r+1]>o.scale_ymax)||(l.fP[r+2]<o.scale_zmin)||(l.fP[r+2]>o.scale_zmax)){continue}++q}if((a.gStyle.OptimizeDraw>0)&&(q>s)){n=Math.floor(q/s);if(n<=2){n=2}}var x=Math.floor(q/n),p=new a.Painter.PointsCreator(x,o.webgl,o.size_xy3d/100),t=new Int32Array(x),u=0,v=0;for(var r=0;r<l.fP.length;r+=3){if((l.fP[r]<o.scale_xmin)||(l.fP[r]>o.scale_xmax)||(l.fP[r+1]<o.scale_ymin)||(l.fP[r+1]>o.scale_ymax)||(l.fP[r+2]<o.scale_zmin)||(l.fP[r+2]>o.scale_zmax)){continue}if(n>1){u=(u+1)%n;if(u!==0){continue}}t[v++]=r;p.AddPoint(o.grx(l.fP[r]),o.gry(l.fP[r+1]),o.grz(l.fP[r+2]))}var w=p.CreatePoints(this.get_color(l.fMarkerColor));o.toplevel.add(w);w.tip_color=(l.fMarkerColor===3)?16711680:65280;w.tip_name=l.fName||"Poly3D";w.poly=l;w.painter=o;w.scale0=0.7*p.scale;w.index=t;w.tooltip=function(y){var C=Math.floor(y.index/this.nvertex);if((C<0)||(C>=this.index.length)){return null}C=this.index[C];var D=this.painter,B=D.grx(this.poly.fP[C]),A=D.gry(this.poly.fP[C+1]),z=D.grz(this.poly.fP[C+2]);return{x1:B-this.scale0,x2:B+this.scale0,y1:A-this.scale0,y2:A+this.scale0,z1:z-this.scale0,z2:z+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+C/3,"x: "+D.x_handle.format(this.poly.fP[C]),"y: "+D.y_handle.format(this.poly.fP[C+1]),"z: "+D.z_handle.format(this.poly.fP[C+2])]}};o.Render3D(100)};j.Redraw();return j.DrawingReady()};a.TH3Painter=h;a.TGraph2DPainter=e;return a}));